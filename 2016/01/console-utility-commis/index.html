<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Building a Console Utility with Commis | Libelli</title>
<meta name=keywords content><meta name=description content="Applications like Git or Django&rsquo;s management utility provide a rich interaction between a software library and their users by exposing many subcommands from a single root command. This style of what is essentially better argument parsing simplifies the user experience by only forcing them to remember one primary command, and allows the exploration of the utility hierarchy by using --help and other visibility mechanisms. Moreover, it allows the utility writer to decouple different commands or actions from each other."><meta name=author content="Benjamin Bengfort"><link rel=canonical href=https://bbengfort.github.io/2016/01/console-utility-commis/><link crossorigin=anonymous href=/assets/css/stylesheet.fc220c15db4aef0318bbf30adc45d33d4d7c88deff3238b23eb255afdc472ca6.css integrity="sha256-/CIMFdtK7wMYu/MK3EXTPU18iN7/MjiyPrJVr9xHLKY=" rel="preload stylesheet" as=style><link rel=icon href=https://bbengfort.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://bbengfort.github.io/icon.png><link rel=icon type=image/png sizes=32x32 href=https://bbengfort.github.io/icon.png><link rel=apple-touch-icon href=https://bbengfort.github.io/apple-touch-icon-precomposed.png><link rel=mask-icon href=https://bbengfort.github.io/icon.png><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://bbengfort.github.io/2016/01/console-utility-commis/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-D3BE7EHHVP"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-D3BE7EHHVP")}</script><meta property="og:title" content="Building a Console Utility with Commis"><meta property="og:description" content="Applications like Git or Django&rsquo;s management utility provide a rich interaction between a software library and their users by exposing many subcommands from a single root command. This style of what is essentially better argument parsing simplifies the user experience by only forcing them to remember one primary command, and allows the exploration of the utility hierarchy by using --help and other visibility mechanisms. Moreover, it allows the utility writer to decouple different commands or actions from each other."><meta property="og:type" content="article"><meta property="og:url" content="https://bbengfort.github.io/2016/01/console-utility-commis/"><meta property="og:image" content="https://bbengfort.github.io/bear.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2016-01-23T08:46:18+00:00"><meta property="article:modified_time" content="2016-01-23T08:46:18+00:00"><meta property="og:site_name" content="Libelli"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://bbengfort.github.io/bear.png"><meta name=twitter:title content="Building a Console Utility with Commis"><meta name=twitter:description content="Applications like Git or Django&rsquo;s management utility provide a rich interaction between a software library and their users by exposing many subcommands from a single root command. This style of what is essentially better argument parsing simplifies the user experience by only forcing them to remember one primary command, and allows the exploration of the utility hierarchy by using --help and other visibility mechanisms. Moreover, it allows the utility writer to decouple different commands or actions from each other."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://bbengfort.github.io/posts/"},{"@type":"ListItem","position":2,"name":"Building a Console Utility with Commis","item":"https://bbengfort.github.io/2016/01/console-utility-commis/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Building a Console Utility with Commis","name":"Building a Console Utility with Commis","description":"Applications like Git or Django\u0026rsquo;s management utility provide a rich interaction between a software library and their users by exposing many subcommands from a single root command. This style of what is essentially better argument parsing simplifies the user experience by only forcing them to remember one primary command, and allows the exploration of the utility hierarchy by using --help and other visibility mechanisms. Moreover, it allows the utility writer to decouple different commands or actions from each other.\n","keywords":[],"articleBody":"Applications like Git or Django’s management utility provide a rich interaction between a software library and their users by exposing many subcommands from a single root command. This style of what is essentially better argument parsing simplifies the user experience by only forcing them to remember one primary command, and allows the exploration of the utility hierarchy by using --help and other visibility mechanisms. Moreover, it allows the utility writer to decouple different commands or actions from each other.\nAnd, this is actually not very hard to do, as shown in [“Simple CLI Script with Argparse”]({% post_url 2016-01-10-simple-cli-argparse %}), the argparse module in the standard library will allow you to create subparsers. By setting a default “handling” function associated with each subparser, you can simply execute different functions with different arguments from the command line. Unfortunately, while easy, the organization and definition of the utility quickly gets out of control, particularly as the argparse.add_argument method is so verbose.\nEnter Commis, a library designed to make define and organizing complex command line utilities easier. Commis was inspired by the Django management utility, and was written specifically to provide similar functionality and code organization in other projects. The design principles are simple:\nMaintain console commands inside of a library. Define arguments simply and extensibly (with better formatting). Easily and automatically add commands to the console utility. Decouple the execution context (argument parsing, output). Compose the most simple executable script possible. In this tutorial we will see how to build a console utility using Commis. This tutorial is applicable both to user facing console tools (e.g. Git) or library specific tools (e.g. django-admin). We will focus on organization and package management rather than the details of writing command code, as this is where Commis shines. For the purposes of this tutorial, we will consider the building of a console utility that acts like a static site generator and has two primary commands: build and serve.\nCode Organization One of the most important things to understand about Commis is how to organize larger projects in order to manage complex utilities. In our tutorial example we are creating a static site generator called foo with two commands, build and serve. Following the basic template for a Python project, a very simple organization for foo would be as follows:\n$ project . ├── foo | ├── __init__.py | ├── console | | ├── commands | | | ├── __init__.py | | | ├── build.py | | | └── serve.py | | ├── __init__.py | | └── app.py ├── foo-app.py ├── LICENSE.txt ├── README.md ├── requirements.txt └── setup.py Our primary code base is in the foo library, which should hold 99% of the Python code. The only other Python modules in this example that are outside of the foo library are foo-app.py and setup.py. The foo-app.py script is the main entry point for our application and is very simple, which we will see shortly. The setup.py script is for packaging and distribution via pip, which will will also discuss in a bit.\nThe foo package includes a foo.console module, which in turn contains a foo.console.commands and foo.console.app modules. The app module will contain a subclass of commis.ConsoleProgram, which defines how our console application should behave. The commands module will organize our various subcommands, and as you can see, the build and serve modules are already listed, in which the build and serve commands will be implemented by extending commis.Command. We will discuss the ConsoleProgram and Command interfaces in detail.\nThe foo-app.py should be incredibly simple, even though it is the main entry point to the application. In fact, all it should do is import the console utility from foo.console.app and execute it, that’s it. It will pretty much look as follows:\n#!/usr/bin/env python from foo.console.app import FooApp if __name__ == '__main__': app = FooApp.load() app.execute() The shebang (#!/usr/bin/env python) ensures that this simple program will execute with Python. Give it executable permissions as follows:\n$ chmod +x foo-app.py This script is the part of your Python project that will eventually get installed into the $PATH of the user. Using setuptools (pip) for packaging, you would simply list foo-app.py in the scripts keyword argument of the setup function as follows:\nfrom setuptools import setup if __name__ == '__main__': setup( name='foo', version='1.0', py_modules=['foo'], scripts=['foo-app.py'] ) For more details on Python code organization see [“Basic Python Project Files”]({% post_url 2016-01-09-project-start %}). For more details on packaging and the setup.py file see [“Packaging Python Libraries with PyPI”]({% post_url 2016-01-20-packaging-with-pypi %}).\nCreating a Console Utility The Commis library utilizes a class-based interface for defining console utilities and commands. The primary usage is to subclass (extend) both the ConsoleProgram and the Command class for your purposes, however this is not required. In fact, given two commands, you could easily build a console utility as follows:\n#!/usr/bin/env python from commis import ConsoleProgram from foo.console.commands import BuildCommand, ServeCommand app = ConsoleProgram( description='my foo app', epilog='postscript', version='1.0' ) app.register(BuildCommand) app.register(ServeCommand) app.execute() The ConsoleProgram.register command takes a Command subclass, and registers it to the console utility, building the necessary parser and subparser classes that the argparse module requires. You cannot add a command to a console utility without calling register. While the register method is easy, it does not allow you to manage, extend, or reuse the utility for different purposes. Instead, I recommend extending ConsoleProgram and modifying it as follows.\n# foo.console.app # An extended console utility import foo from commis import ConsoleProgram from foo.console.commands import * COMMANDS = [ BuildCommand, ServeCommand, ] class FooApp(ConsoleProgram): description = \"my foo app\" epilog = \"please submit any issues to the bug tracker\" version = foo.__version__ @classmethod def load(klass, commands=COMMANDS): utility = klass() for command in commands: utility.register(command) return utility This technique integrates your application with your library in a couple of meaningful ways. First, the importing and inclusion of commands from in your library means that you can easily control and version which commands are part of the utility and which are deprecated. Secondly, the version is tied to the library version, and other constants like the description and epilog are also easily maintained and can be string formatted from other meta information.\nCreating Commands Now that we have the infrastructure in place, it’s time to start creating commands for our application. Adding new commands to the utility is as simple as creating a command class, importing it in foo.console.app and adding the command class to the COMMANDS list. This technique means you have an easy way to add, edit, and manage commands without affecting other commands. Here is an example serve command:\nfrom commis import Command # From the Python standard library from BaseHTTPServer import HTTPServer from SimpleHTTPServer import SimpleHTTPRequestHandler class ServeCommand(Command): name = 'serve' help = 'a simple web server which serves files from the working directory' args = { ('-p', '--port'): { 'type': int, 'default': 8080, 'help': 'the port to serve on', }, ('-a', '--addr'): { 'type': str, 'default': 'localhost', 'help': 'the address to serve on' } } def handle(self, args): \"\"\" Create the web server \"\"\" server = HTTPServer((args.addr, args.port), SimpleHTTPRequestHandler) print \"Server started on http://{}:{}\".format(args.addr, args.port) try: server.serve_forever() except (KeyboardInterrupt, SystemExit): return \"Server successfully stopped!\" The Command subclass basically defines how the command is utilized in the console through four primary attributes: name, help, args, and handle. The name and help arguments are used to describe the command and are passed to the argparse library. When you do:\n$ foo-app.py {name} --help The {name} is the Command.name and the description will be what you listed in Command.help. The args attribute specifies the expected arguments for parsing on the command line. It is a dictionary, whose key is either a string or a tuple, which defines the name of the argument, and whose value is another dictionary representing the keyword arguments that get passed to argparse.add_argument. These arguments are added automatically to the parser and subparser during command registration. Specifying commands this way is a clean and easy way of creating argparse subparsers!\nDefault Options There are two default options that are included with every command by default: --traceback and --pythonpath. The --traceback argument specifies that if there is an error, then print out the entire stack trace (similar to what you might expect from a Python program with an exception that is not caught). This is useful for debugging, but often not useful for users. For that reason --traceback is by default False. Instead, the string representation of the error will be printed in red text. In fact, if there is a user related error, it is usually best to raise a commis.ConsoleError with a string message for users in particular:\nfrom commis import Command from commis.exceptions import ConsoleError class MyCommand(Command): name = 'open' help = 'opens the bay doors.' def handle(self, args): raise ConsoleError(\"I'm sorry, I cannot do that, Dave.\") The --pythonpath option allows you to append paths to sys.path to include Python code that is not in your site-packages. This is also good for development and for tools that are intended for developers as it helps avoid import errors.\nReusing Options The default options above were created through a subclass of argparse.ArgumentParser as shown:\nimport argparse class DefaultParser(argparse.ArgumentParser): TRACEBACK = { 'action': 'store_true', 'default': False, 'help': 'On error, show the Python traceback', } PYTHONPATH = { 'type': str, 'required': False, 'metavar': 'PATH', 'help': 'A directory to add to the Python path', } def __init__(self, *args, **kwargs): ## Create the parser kwargs['add_help'] = False super(DefaultParser, self).__init__(*args, **kwargs) ## Add the defaults self.add_default_arguments() def add_default_arguments(self): self.add_argument('--traceback', **self.TRACEBACK) self.add_argument('--pythonpath', **self.PYTHONPATH) If you have options that you are reusing again and again, you can do something similar for your arguments, e.g. FooParser, then add them to your commands with the parents attribute as follows:\nfrom commis import Command from commis.command import DefaultParser from foo.console import FooParser class BarCommand(Command): name = 'bar' help = 'an example command' parents = [DefaultParser(), FooParser()] This will ensure that you have both the default arguments as well as the foo arguments that are shared. Additionally if you wish to remove --traceback and --pythonpath then simply set parents to an empty list.\nConclusion In this post we have seen how to build a console utility with Commis - a library designed for easy console programs included with much larger libraries. As you can see, Commis is mostly about code organization and reusability. Hopefully this package will allow you to quickly and easily create utilities of your own. I’m always interested in feedback, please feel free to submit pull requests to the Commis GitHub repository!\n","wordCount":"1753","inLanguage":"en","image":"https://bbengfort.github.io/bear.png","datePublished":"2016-01-23T08:46:18Z","dateModified":"2016-01-23T08:46:18Z","author":{"@type":"Person","name":"Benjamin Bengfort"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://bbengfort.github.io/2016/01/console-utility-commis/"},"publisher":{"@type":"Organization","name":"Libelli","logo":{"@type":"ImageObject","url":"https://bbengfort.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://bbengfort.github.io/ accesskey=h title="Libelli (Alt + H)"><img src=https://bbengfort.github.io/icon.png alt aria-label=logo height=35>Libelli</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://bbengfort.github.io/archive/ title=archive><span>archive</span></a></li><li><a href=https://bbengfort.github.io/categories/ title=categories><span>categories</span></a></li><li><a href=https://bbengfort.github.io/search/ title="search (Alt + /)" accesskey=/><span>search</span></a></li><li><a href=https://bbengfort.github.io/about/ title=about><span>about</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://bbengfort.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://bbengfort.github.io/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">Building a Console Utility with Commis</h1><div class=post-meta><span title='2016-01-23 08:46:18 +0000 UTC'>January 23, 2016</span>&nbsp;·&nbsp;9 min&nbsp;·&nbsp;1753 words&nbsp;·&nbsp;Benjamin Bengfort&nbsp;|&nbsp;<a href=https://github.com/bbengfort/bbengfort.github.io/tree/main/content/posts/2016-01-23-console-utility-commis.md rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><div class=post-content><p>Applications like <a href=https://git-scm.com/>Git</a> or <a href=https://docs.djangoproject.com/en/1.9/ref/django-admin/>Django&rsquo;s management utility</a> provide a rich interaction between a software library and their users by exposing many subcommands from a single root command. This style of what is essentially better argument parsing simplifies the user experience by only forcing them to remember one primary command, and allows the exploration of the utility hierarchy by using <code>--help</code> and other visibility mechanisms. Moreover, it allows the utility writer to decouple different commands or actions from each other.</p><p>And, this is actually not very hard to do, as shown in [“Simple CLI Script with Argparse”]({% post_url 2016-01-10-simple-cli-argparse %}), the <code>argparse</code> module in the standard library will allow you to create subparsers. By setting a default “handling” function associated with each subparser, you can simply execute different functions with different arguments from the command line. Unfortunately, while easy, the <em>organization</em> and <em>definition</em> of the utility quickly gets out of control, particularly as the <code>argparse.add_argument</code> method is so verbose.</p><p>Enter <a href=https://github.com/bbengfort/commis>Commis</a>, a library designed to make define and organizing complex command line utilities easier. Commis was inspired by the Django management utility, and was written specifically to provide similar functionality and code organization in other projects. The design principles are simple:</p><ol><li>Maintain console commands inside of a library.</li><li>Define arguments simply and extensibly (with better formatting).</li><li>Easily and automatically add commands to the console utility.</li><li>Decouple the execution context (argument parsing, output).</li><li>Compose the most simple executable script possible.</li></ol><p>In this tutorial we will see how to build a console utility using Commis. This tutorial is applicable both to user facing console tools (e.g. Git) or library specific tools (e.g. django-admin). We will focus on organization and package management rather than the details of writing command code, as this is where Commis shines. For the purposes of this tutorial, we will consider the building of a console utility that acts like a static site generator and has two primary commands: <code>build</code> and <code>serve</code>.</p><h2 id=code-organization>Code Organization<a hidden class=anchor aria-hidden=true href=#code-organization>#</a></h2><p>One of the most important things to understand about Commis is how to organize larger projects in order to manage complex utilities. In our tutorial example we are creating a static site generator called <code>foo</code> with two commands, <code>build</code> and <code>serve</code>. Following the basic template for a Python project, a very simple organization for <code>foo</code> would be as follows:</p><pre tabindex=0><code>$ project
.
├── foo
|   ├── __init__.py
|   ├── console
|   |   ├── commands    
|   |   |   ├── __init__.py
|   |   |   ├── build.py
|   |   |   └── serve.py
|   |   ├── __init__.py
|   |   └── app.py
├── foo-app.py
├── LICENSE.txt
├── README.md
├── requirements.txt
└── setup.py
</code></pre><p>Our primary code base is in the <code>foo</code> library, which should hold 99% of the Python code. The only other Python modules in this example that are outside of the <code>foo</code> library are <code>foo-app.py</code> and <code>setup.py</code>. The <code>foo-app.py</code> script is the main entry point for our application and is very simple, which we will see shortly. The <code>setup.py</code> script is for packaging and distribution via <code>pip</code>, which will will also discuss in a bit.</p><p>The <code>foo</code> package includes a <code>foo.console</code> module, which in turn contains a <code>foo.console.commands</code> and <code>foo.console.app</code> modules. The <code>app</code> module will contain a subclass of <code>commis.ConsoleProgram</code>, which defines how our console application should behave. The <code>commands</code> module will organize our various subcommands, and as you can see, the <code>build</code> and <code>serve</code> modules are already listed, in which the <code>build</code> and <code>serve</code> commands will be implemented by extending <code>commis.Command</code>. We will discuss the <code>ConsoleProgram</code> and <code>Command</code> interfaces in detail.</p><p>The <code>foo-app.py</code> should be incredibly simple, even though it is the main entry point to the application. In fact, all it should do is import the console utility from <code>foo.console.app</code> and execute it, <em>that&rsquo;s it</em>. It will pretty much look as follows:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=ch>#!/usr/bin/env python</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>foo.console.app</span> <span class=kn>import</span> <span class=n>FooApp</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s1>&#39;__main__&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>app</span> <span class=o>=</span> <span class=n>FooApp</span><span class=o>.</span><span class=n>load</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>app</span><span class=o>.</span><span class=n>execute</span><span class=p>()</span>
</span></span></code></pre></div><p>The shebang (<code>#!/usr/bin/env python</code>) ensures that this simple program will execute with Python. Give it executable permissions as follows:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ chmod +x foo-app.py
</span></span></code></pre></div><p>This script is the part of your Python project that will eventually get installed into the <code>$PATH</code> of the user. Using <code>setuptools</code> (<code>pip</code>) for packaging, you would simply list <code>foo-app.py</code> in the <code>scripts</code> keyword argument of the <code>setup</code> function as follows:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>setuptools</span> <span class=kn>import</span> <span class=n>setup</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s1>&#39;__main__&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>setup</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>name</span><span class=o>=</span><span class=s1>&#39;foo&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>version</span><span class=o>=</span><span class=s1>&#39;1.0&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>py_modules</span><span class=o>=</span><span class=p>[</span><span class=s1>&#39;foo&#39;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>        <span class=n>scripts</span><span class=o>=</span><span class=p>[</span><span class=s1>&#39;foo-app.py&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span></code></pre></div><p>For more details on Python code organization see [“Basic Python Project Files”]({% post_url 2016-01-09-project-start %}). For more details on packaging and the <code>setup.py</code> file see [“Packaging Python Libraries with PyPI”]({% post_url 2016-01-20-packaging-with-pypi %}).</p><h2 id=creating-a-console-utility>Creating a Console Utility<a hidden class=anchor aria-hidden=true href=#creating-a-console-utility>#</a></h2><p>The Commis library utilizes a class-based interface for defining console utilities and commands. The primary usage is to subclass (extend) both the <code>ConsoleProgram</code> and the <code>Command</code> class for your purposes, however this is not required. In fact, given two commands, you could easily build a console utility as follows:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=ch>#!/usr/bin/env python</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>commis</span> <span class=kn>import</span> <span class=n>ConsoleProgram</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>foo.console.commands</span> <span class=kn>import</span> <span class=n>BuildCommand</span><span class=p>,</span> <span class=n>ServeCommand</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>app</span> <span class=o>=</span> <span class=n>ConsoleProgram</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>description</span><span class=o>=</span><span class=s1>&#39;my foo app&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>epilog</span><span class=o>=</span><span class=s1>&#39;postscript&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>version</span><span class=o>=</span><span class=s1>&#39;1.0&#39;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>app</span><span class=o>.</span><span class=n>register</span><span class=p>(</span><span class=n>BuildCommand</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>app</span><span class=o>.</span><span class=n>register</span><span class=p>(</span><span class=n>ServeCommand</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>app</span><span class=o>.</span><span class=n>execute</span><span class=p>()</span>
</span></span></code></pre></div><p>The <code>ConsoleProgram.register</code> command takes a <code>Command</code> subclass, and registers it to the console utility, building the necessary parser and subparser classes that the <code>argparse</code> module requires. You cannot add a command to a console utility without calling <code>register</code>. While the register method is easy, it does not allow you to manage, extend, or reuse the utility for different purposes. Instead, I recommend extending <code>ConsoleProgram</code> and modifying it as follows.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># foo.console.app</span>
</span></span><span class=line><span class=cl><span class=c1># An extended console utility</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>foo</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>commis</span> <span class=kn>import</span> <span class=n>ConsoleProgram</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>foo.console.commands</span> <span class=kn>import</span> <span class=o>*</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>COMMANDS</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=n>BuildCommand</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>ServeCommand</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>FooApp</span><span class=p>(</span><span class=n>ConsoleProgram</span><span class=p>):</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>description</span> <span class=o>=</span> <span class=s2>&#34;my foo app&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>epilog</span>      <span class=o>=</span> <span class=s2>&#34;please submit any issues to the bug tracker&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>version</span>     <span class=o>=</span> <span class=n>foo</span><span class=o>.</span><span class=n>__version__</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@classmethod</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>load</span><span class=p>(</span><span class=n>klass</span><span class=p>,</span> <span class=n>commands</span><span class=o>=</span><span class=n>COMMANDS</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>utility</span> <span class=o>=</span> <span class=n>klass</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>command</span> <span class=ow>in</span> <span class=n>commands</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>utility</span><span class=o>.</span><span class=n>register</span><span class=p>(</span><span class=n>command</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>utility</span>
</span></span></code></pre></div><p>This technique integrates your application with your library in a couple of meaningful ways. First, the importing and inclusion of commands from in your library means that you can easily control and version which commands are part of the utility and which are deprecated. Secondly, the version is tied to the library version, and other constants like the description and epilog are also easily maintained and can be string formatted from other meta information.</p><h2 id=creating-commands>Creating Commands<a hidden class=anchor aria-hidden=true href=#creating-commands>#</a></h2><p>Now that we have the infrastructure in place, it&rsquo;s time to start creating commands for our application. Adding new commands to the utility is as simple as creating a command class, importing it in <code>foo.console.app</code> and adding the command class to the <code>COMMANDS</code> list. This technique means you have an easy way to add, edit, and manage commands without affecting other commands. Here is an example serve command:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>commis</span> <span class=kn>import</span> <span class=n>Command</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># From the Python standard library</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>BaseHTTPServer</span> <span class=kn>import</span> <span class=n>HTTPServer</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>SimpleHTTPServer</span> <span class=kn>import</span> <span class=n>SimpleHTTPRequestHandler</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>ServeCommand</span><span class=p>(</span><span class=n>Command</span><span class=p>):</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>name</span> <span class=o>=</span> <span class=s1>&#39;serve&#39;</span>
</span></span><span class=line><span class=cl>    <span class=n>help</span> <span class=o>=</span> <span class=s1>&#39;a simple web server which serves files from the working directory&#39;</span>
</span></span><span class=line><span class=cl>    <span class=n>args</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=p>(</span><span class=s1>&#39;-p&#39;</span><span class=p>,</span> <span class=s1>&#39;--port&#39;</span><span class=p>):</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;type&#39;</span><span class=p>:</span> <span class=nb>int</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;default&#39;</span><span class=p>:</span> <span class=mi>8080</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;help&#39;</span><span class=p>:</span> <span class=s1>&#39;the port to serve on&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=p>(</span><span class=s1>&#39;-a&#39;</span><span class=p>,</span> <span class=s1>&#39;--addr&#39;</span><span class=p>):</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;type&#39;</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;default&#39;</span><span class=p>:</span> <span class=s1>&#39;localhost&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;help&#39;</span><span class=p>:</span> <span class=s1>&#39;the address to serve on&#39;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>handle</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>args</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>        Create the web server
</span></span></span><span class=line><span class=cl><span class=s2>        &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>server</span> <span class=o>=</span> <span class=n>HTTPServer</span><span class=p>((</span><span class=n>args</span><span class=o>.</span><span class=n>addr</span><span class=p>,</span> <span class=n>args</span><span class=o>.</span><span class=n>port</span><span class=p>),</span> <span class=n>SimpleHTTPRequestHandler</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span> <span class=s2>&#34;Server started on http://</span><span class=si>{}</span><span class=s2>:</span><span class=si>{}</span><span class=s2>&#34;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>args</span><span class=o>.</span><span class=n>addr</span><span class=p>,</span> <span class=n>args</span><span class=o>.</span><span class=n>port</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>server</span><span class=o>.</span><span class=n>serve_forever</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>except</span> <span class=p>(</span><span class=ne>KeyboardInterrupt</span><span class=p>,</span> <span class=ne>SystemExit</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=s2>&#34;Server successfully stopped!&#34;</span>
</span></span></code></pre></div><p>The <code>Command</code> subclass basically defines how the command is utilized in the console through four primary attributes: <code>name</code>, <code>help</code>, <code>args</code>, and <code>handle</code>. The <code>name</code> and <code>help</code> arguments are used to describe the command and are passed to the <code>argparse</code> library. When you do:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ foo-app.py <span class=o>{</span>name<span class=o>}</span> --help
</span></span></code></pre></div><p>The <code>{name}</code> is the <code>Command.name</code> and the description will be what you listed in <code>Command.help</code>. The <code>args</code> attribute specifies the expected arguments for parsing on the command line. It is a dictionary, whose key is either a string or a tuple, which defines the name of the argument, and whose value is another dictionary representing the keyword arguments that get passed to <code>argparse.add_argument</code>. These arguments are added automatically to the parser and subparser during command registration. Specifying commands this way is a clean and easy way of creating <code>argparse</code> subparsers!</p><h3 id=default-options>Default Options<a hidden class=anchor aria-hidden=true href=#default-options>#</a></h3><p>There are two default options that are included with <em>every</em> command by default: <code>--traceback</code> and <code>--pythonpath</code>. The <code>--traceback</code> argument specifies that if there is an error, then print out the entire stack trace (similar to what you might expect from a Python program with an exception that is not caught). This is useful for debugging, but often not useful for users. For that reason <code>--traceback</code> is by default <code>False</code>. Instead, the string representation of the error will be printed in red text. In fact, if there is a user related error, it is usually best to raise a <code>commis.ConsoleError</code> with a string message for users in particular:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>commis</span> <span class=kn>import</span> <span class=n>Command</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>commis.exceptions</span> <span class=kn>import</span> <span class=n>ConsoleError</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>MyCommand</span><span class=p>(</span><span class=n>Command</span><span class=p>):</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>name</span> <span class=o>=</span> <span class=s1>&#39;open&#39;</span>
</span></span><span class=line><span class=cl>    <span class=n>help</span> <span class=o>=</span> <span class=s1>&#39;opens the bay doors.&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>handle</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>args</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>raise</span> <span class=n>ConsoleError</span><span class=p>(</span><span class=s2>&#34;I&#39;m sorry, I cannot do that, Dave.&#34;</span><span class=p>)</span>
</span></span></code></pre></div><p>The <code>--pythonpath</code> option allows you to append paths to <code>sys.path</code> to include Python code that is not in your site-packages. This is also good for development and for tools that are intended for developers as it helps avoid import errors.</p><h3 id=reusing-options>Reusing Options<a hidden class=anchor aria-hidden=true href=#reusing-options>#</a></h3><p>The default options above were created through a subclass of <code>argparse.ArgumentParser</code> as shown:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>argparse</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>DefaultParser</span><span class=p>(</span><span class=n>argparse</span><span class=o>.</span><span class=n>ArgumentParser</span><span class=p>):</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>TRACEBACK</span>  <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;action&#39;</span><span class=p>:</span>  <span class=s1>&#39;store_true&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;default&#39;</span><span class=p>:</span> <span class=kc>False</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;help&#39;</span><span class=p>:</span> <span class=s1>&#39;On error, show the Python traceback&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>PYTHONPATH</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;type&#39;</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;required&#39;</span><span class=p>:</span> <span class=kc>False</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;metavar&#39;</span><span class=p>:</span> <span class=s1>&#39;PATH&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;help&#39;</span><span class=p>:</span> <span class=s1>&#39;A directory to add to the Python path&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=c1>## Create the parser</span>
</span></span><span class=line><span class=cl>        <span class=n>kwargs</span><span class=p>[</span><span class=s1>&#39;add_help&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>        <span class=nb>super</span><span class=p>(</span><span class=n>DefaultParser</span><span class=p>,</span> <span class=bp>self</span><span class=p>)</span><span class=o>.</span><span class=fm>__init__</span><span class=p>(</span><span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>## Add the defaults</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>add_default_arguments</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>add_default_arguments</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>add_argument</span><span class=p>(</span><span class=s1>&#39;--traceback&#39;</span><span class=p>,</span> <span class=o>**</span><span class=bp>self</span><span class=o>.</span><span class=n>TRACEBACK</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>add_argument</span><span class=p>(</span><span class=s1>&#39;--pythonpath&#39;</span><span class=p>,</span> <span class=o>**</span><span class=bp>self</span><span class=o>.</span><span class=n>PYTHONPATH</span><span class=p>)</span>
</span></span></code></pre></div><p>If you have options that you are reusing again and again, you can do something similar for your arguments, e.g. <code>FooParser</code>, then add them to your commands with the <code>parents</code> attribute as follows:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>commis</span> <span class=kn>import</span> <span class=n>Command</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>commis.command</span> <span class=kn>import</span> <span class=n>DefaultParser</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>foo.console</span> <span class=kn>import</span> <span class=n>FooParser</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>BarCommand</span><span class=p>(</span><span class=n>Command</span><span class=p>):</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>name</span> <span class=o>=</span> <span class=s1>&#39;bar&#39;</span>
</span></span><span class=line><span class=cl>    <span class=n>help</span> <span class=o>=</span> <span class=s1>&#39;an example command&#39;</span>
</span></span><span class=line><span class=cl>    <span class=n>parents</span> <span class=o>=</span> <span class=p>[</span><span class=n>DefaultParser</span><span class=p>(),</span> <span class=n>FooParser</span><span class=p>()]</span>
</span></span></code></pre></div><p>This will ensure that you have both the default arguments as well as the foo arguments that are shared. Additionally if you wish to remove <code>--traceback</code> and <code>--pythonpath</code> then simply set parents to an empty list.</p><h2 id=conclusion>Conclusion<a hidden class=anchor aria-hidden=true href=#conclusion>#</a></h2><p>In this post we have seen how to build a console utility with Commis - a library designed for easy console programs included with much larger libraries. As you can see, Commis is mostly about code organization and reusability. Hopefully this package will allow you to quickly and easily create utilities of your own. I&rsquo;m always interested in feedback, please feel free to submit pull requests to the Commis GitHub repository!</p></div><footer class=post-footer><ul class=post-tags></ul><nav class=paginav><a class=prev href=https://bbengfort.github.io/2016/01/timeline-visualization/><span class=title>« Prev</span><br><span>Timeline Visualization with Matplotlib</span>
</a><a class=next href=https://bbengfort.github.io/2016/01/freezing-requirements/><span class=title>Next »</span><br><span>Freezing Package Requirements</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2024 <a href=https://bbengfort.github.io/>Libelli</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>