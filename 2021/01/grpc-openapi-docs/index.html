<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Documenting a gRPC API with OpenAPI | Libelli</title><meta name=keywords content><meta name=description content="gRPC makes the specification and implementation of networked APIs a snap. But what is the simplest way to document a gRPC API? There seem to be some hosted providers by Google, e.g. SmartDocs, but I have yet to find a gRPC-specific tool. For REST API frameworks, documentation is commonly generated along with live examples using OpenAPI (formerly swagger). By using grpc-gateway it appears to be pretty straight forward to generate a REST/gRPC API combo from protocol buffers and then hook into the OpenAPI specification."><meta name=author content="Benjamin Bengfort"><link rel=canonical href=https://bbengfort.github.io/2021/01/grpc-openapi-docs/><link crossorigin=anonymous href=/assets/css/stylesheet.3613efbd0b1772781e8f49935e973cae632a7f61471c05b17be155505ccf87b5.css integrity="sha256-NhPvvQsXcngej0mTXpc8rmMqf2FHHAWxe+FVUFzPh7U=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://bbengfort.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://bbengfort.github.io/icon.png><link rel=icon type=image/png sizes=32x32 href=https://bbengfort.github.io/icon.png><link rel=apple-touch-icon href=https://bbengfort.github.io/apple-touch-icon-precomposed.png><link rel=mask-icon href=https://bbengfort.github.io/icon.png><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-D3BE7EHHVP"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-D3BE7EHHVP",{anonymize_ip:!1})}</script><meta property="og:title" content="Documenting a gRPC API with OpenAPI"><meta property="og:description" content="gRPC makes the specification and implementation of networked APIs a snap. But what is the simplest way to document a gRPC API? There seem to be some hosted providers by Google, e.g. SmartDocs, but I have yet to find a gRPC-specific tool. For REST API frameworks, documentation is commonly generated along with live examples using OpenAPI (formerly swagger). By using grpc-gateway it appears to be pretty straight forward to generate a REST/gRPC API combo from protocol buffers and then hook into the OpenAPI specification."><meta property="og:type" content="article"><meta property="og:url" content="https://bbengfort.github.io/2021/01/grpc-openapi-docs/"><meta property="og:image" content="https://bbengfort.github.io/bear.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-01-21T17:45:35+00:00"><meta property="article:modified_time" content="2021-01-21T17:45:35+00:00"><meta property="og:site_name" content="Libelli"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://bbengfort.github.io/bear.png"><meta name=twitter:title content="Documenting a gRPC API with OpenAPI"><meta name=twitter:description content="gRPC makes the specification and implementation of networked APIs a snap. But what is the simplest way to document a gRPC API? There seem to be some hosted providers by Google, e.g. SmartDocs, but I have yet to find a gRPC-specific tool. For REST API frameworks, documentation is commonly generated along with live examples using OpenAPI (formerly swagger). By using grpc-gateway it appears to be pretty straight forward to generate a REST/gRPC API combo from protocol buffers and then hook into the OpenAPI specification."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://bbengfort.github.io/posts/"},{"@type":"ListItem","position":3,"name":"Documenting a gRPC API with OpenAPI","item":"https://bbengfort.github.io/2021/01/grpc-openapi-docs/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Documenting a gRPC API with OpenAPI","name":"Documenting a gRPC API with OpenAPI","description":"gRPC makes the specification and implementation of networked APIs a snap. But what is the simplest way to document a gRPC API? There seem to be some hosted providers by Google, e.g. SmartDocs, but I have yet to find a gRPC-specific tool. For REST API frameworks, documentation is commonly generated along with live examples using OpenAPI (formerly swagger). By using grpc-gateway it appears to be pretty straight forward to generate a REST/gRPC API combo from protocol buffers and then hook into the OpenAPI specification.","keywords":[],"articleBody":"gRPC makes the specification and implementation of networked APIs a snap. But what is the simplest way to document a gRPC API? There seem to be some hosted providers by Google, e.g. SmartDocs, but I have yet to find a gRPC-specific tool. For REST API frameworks, documentation is commonly generated along with live examples using OpenAPI (formerly swagger). By using grpc-gateway it appears to be pretty straight forward to generate a REST/gRPC API combo from protocol buffers and then hook into the OpenAPI specification.\nIn this post, I’ll go through the creation of docs from gRPC protocol buffers. In a following post, I’ll go through the creation of a live gRPC/REST service with Swagger documentation.\nStep 1: Define the service.\nWe’ll create a simple “notes” service that has two endpoints: create a note and fetch notes, optionally filtered.\nsyntax = \"proto3\"; package notes.v1; option go_package = \"github.com/bbengfort/notes/v1\"; service NoteService { rpc Fetch(NoteFilter) returns (Notebook) {}; rpc Create(Note) returns (Notebook) {}; } message Note { uint64 id = 1; string timestamp = 2; string author = 3; string text = 4; bool private = 5; } message NoteFilter { repeated uint64 ids = 1; repeated string author = 2; string before = 3; string after = 4; bool private = 5; } message Notebook { Error error = 1; repeated Note notes = 2; } message Error { uint32 code = 1; string message = 2; } So far, this is just a gRPC service definition. If we’re working in a Go project, we can version our API and structure our project as follows:\nWorkspace/go/src/github.com/bbengfort/notes └── cmd | └── notes | | └── main.go ├── go.mod ├── go.sum └── proto | └── notes | | └── v1 | | | └── api.proto Using this directory structure, generate the struct code and server and client interfaces using protoc with go and grpc plugins:\n$ protoc -I ./proto/ \\ --go_out=. --go_opt=module=github.com/bbengfort/notes \\ --go-grpc_out=. --go-grpc_opt=module=github.com/bbengfort/notes \\ proto/notes/v1/*.proto NOTE: You’ll have to install protoc (I did so with brew) and the go and grpc plugins (I used go get). See the gRPC Go Quickstart for more information on the installation process.\nIn this command the -I flag specifies where protoc can look for included protocol buffer files (e.g. if they’re imported) - more on this later. The --go_out and --go-grpc_out flags specify where to write the generated go code and the --go_opt=module= and --go-grpc_out=module flags specify the root Go module. If you run this in the project root, e.g. github.com/bbengfort/notes then a v1 directory will be created with api.pb.go and api_grpc.pb.go inside of it. This is because of the option go_package = \"github.com/bbengfort/notes/v1\"; directive at the top of api.proto which resolves the output path based on all the module directives.\nStep 2: download includes files and install dependencies\nIn order to use the grpc-gateway and openapiv2 protocol buffer plugins, we’ll have to modify our proto file with options that allow us to specify how the REST API is defined and to supply information to the swagger.json generated OpenAPI v2 specification. Custom options are described in third party protocol buffer files that must be included when we generate our protocol buffers using the -I flag.\nNOTE: I believe there is a way to download and “install” third party libraries into a global includes path, e.g. /usr/local/include/google/protobuf but I have to investigate this further.\nTo simplify the use of protoc and to prevent dependency management issues, I just downloaded the needed third-party from grpc-gateway-boilerplate. This appears to be a pattern in some of the repos I’ve seen, adding them to a third_party directory, though I prefer to add them to a include directory. Your directory should now look like:\nWorkspace/go/src/github.com/bbengfort/notes └── cmd | └── notes | | └── main.go ├── go.mod ├── go.sum └── include | └── googleapis | | ├── LICENSE | | └── google | | | └── api | | | | ├── annotations.proto | | | | └── http.proto | | | └── rpc | | | | ├── code.proto | | | | ├── error_details.proto | | | | └── status.proto | └── grpc-gateway | | ├── LICENSE.txt | | └── protoc-gen-openapiv2 | | | └── options | | | | ├── annotations.proto | | | | └── openapiv2.proto └── proto | └── notes | | └── v1 | | | └── api.proto └── v1 | ├── api.pb.go | └── api_grpc.pb.go Finally install the required grpc-gateway plugins so that you have protoc-gen-grpc-gateway and protoc-gen-openapiv2 in your $GOBIN.\nStep 3 (optional): tell vscode where includes are\nIf you’re using VSCode and the vscode-proto3 extension, then I like to add the following directives to my workspace settings (.vscode/settings.json):\n{ \"protoc\": { \"path\": \"/usr/local/bin/protoc\", \"compile_on_save\": false, \"options\": [ \"-I=${workspaceRoot}/proto\", \"-I=${workspaceRoot}/includes/googleapis\", \"-I=${workspaceRoot}/includes/grpc-gateway\", ] } } This prevents import error messages in your protocol buffers and enables autocomplete.\nStep 4: annotate our service\nFinally, we’re to the part we’ve been waiting for - annotating our proto file with the REST and OpenAPI v2 options. At the beginning of api.proto add the following:\nsyntax = \"proto3\"; package notes.v1; option go_package = \"github.com/bbengfort/notes/v1\"; import \"google/api/annotations.proto\"; import \"protoc-gen-openapiv2/options/annotations.proto\"; option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_swagger) = { info: { title: \"Notes\"; version: \"1.0\"; contact: { name: \"bbengfort\"; url: \"https://github.com/bbengfort/notes\"; email: \"info@bengfort.com\"; }; license: { name: \"BSD 3-Clause License\"; url: \"https://github.com/bbengfort/notes/LICENSE\"; }; }; schemes: HTTP; schemes: HTTPS; consumes: \"application/json\"; produces: \"application/json\"; }; When the openapiv2 plugin generates a swagger.json file, the information in this option will be used to populate the info, schemes, consumes, and produces fields of the specificiation. This will both influence the information in the generated documentation as well as make it easier to create a live server.\nNext we must update the service definition to map gRPC services to REST API calls:\nservice NoteService { rpc Fetch(NoteFilter) returns (Notebook) { option (google.api.http) = { get: \"/api/v1/notes\" }; }; rpc Create(Note) returns (Notebook) { option (google.api.http) = { post: \"/api/v1/notes\" body: \"*\" }; }; } These options specify that the Fetch RPC can be accessed with a GET request to /api/v1/notes and that the Create RPC uses POST to the same endpoint. Note that the body: \"*\" flag ensures that the request body is included in endpoint.\nStep 5: generate swagger spec and serve\nIn the final step of this post, we’ll use the openapiv2 plugin to generate the swagger json specification and use the swagger-ui docker image to serve some static documentation.\nprotoc -I ./proto/ \\ -I include/googleapis -I include/grpc-gateway \\ --go_out=. --go_opt=module=github.com/bbengfort/notes \\ --go-grpc_out=. --go-grpc_opt=module=github.com/bbengfort/notes \\ --openapiv2_out ./openapiv2 --openapiv2_opt logtostderr=true \\ proto/notes/v1/*.proto This protoc command has been updated to include the third party protocol buffer files and also adds the openapiv2 plugin, writing a specification file at openapiv2/notes/v1/api.swagger.json (note you may have to make the openapiv2 directory before running this command).\nTo serve the static swagger-ui docs, I used Docker as follows:\n$ docker run -p 80:8080 \\ -e SWAGGER_JSON=/openapiv2/notes/v1/api.swagger.json \\ -v $PWD/openapiv2/:/openapiv2 \\ swaggerapi/swagger-ui This will pull the swaggerapi/swagger-ui image from DockerHub when you run it for the first time. You can then view the docs at http://localhost/:\nThe next steps are to use grpc-gateway to create a server that does both gRPC hosting and a JSON REST API - complete with live Swagger documentation and styling.\n","wordCount":"1197","inLanguage":"en","datePublished":"2021-01-21T17:45:35Z","dateModified":"2021-01-21T17:45:35Z","author":{"@type":"Person","name":"Benjamin Bengfort"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://bbengfort.github.io/2021/01/grpc-openapi-docs/"},"publisher":{"@type":"Organization","name":"Libelli","logo":{"@type":"ImageObject","url":"https://bbengfort.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://bbengfort.github.io accesskey=h title="Libelli (Alt + H)"><img src=https://bbengfort.github.io/icon.png alt aria-label=logo height=35>Libelli</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://bbengfort.github.io/archive/ title=archive><span>archive</span></a></li><li><a href=https://bbengfort.github.io/categories/ title=categories><span>categories</span></a></li><li><a href=https://bbengfort.github.io/search/ title="search (Alt + /)" accesskey=/><span>search</span></a></li><li><a href=https://bbengfort.github.io/about/ title=about><span>about</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://bbengfort.github.io>Home</a>&nbsp;»&nbsp;<a href=https://bbengfort.github.io/posts/>Posts</a></div><h1 class=post-title>Documenting a gRPC API with OpenAPI</h1><div class=post-meta><span title='2021-01-21 17:45:35 +0000 UTC'>January 21, 2021</span>&nbsp;·&nbsp;6 min&nbsp;·&nbsp;1197 words&nbsp;·&nbsp;Benjamin Bengfort&nbsp;|&nbsp;<a href=https://github.com/bbengfort/bbengfort.github.io/tree/main/content/posts/2021-01-21-grpc-openapi-docs.md rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><div class=post-content><p>gRPC makes the specification and implementation of networked APIs a snap. But what is the simplest way to <em>document</em> a gRPC API? There seem to be some hosted providers by Google, e.g. <a href=https://cloud.google.com/endpoints/docs/grpc/dev-portal-update-ref-docs>SmartDocs</a>, but I have yet to find a gRPC-specific tool. For REST API frameworks, documentation is commonly generated along with live examples using <a href=https://swagger.io/resources/open-api/>OpenAPI (formerly swagger)</a>. By using <a href=https://github.com/grpc-ecosystem/grpc-gateway>grpc-gateway</a> it appears to be pretty straight forward to generate a REST/gRPC API combo from protocol buffers and then hook into the OpenAPI specification.</p><p>In this post, I&rsquo;ll go through the creation of docs from gRPC protocol buffers. In a following post, I&rsquo;ll go through the creation of a live gRPC/REST service with Swagger documentation.</p><p><strong>Step 1</strong>: Define the service.</p><p>We&rsquo;ll create a simple &ldquo;notes&rdquo; service that has two endpoints: create a note and fetch notes, optionally filtered.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-protobuf data-lang=protobuf><span class=line><span class=cl><span class=n>syntax</span> <span class=o>=</span> <span class=s>&#34;proto3&#34;</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=kn>package</span> <span class=nn>notes</span><span class=o>.</span><span class=n>v1</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>option</span> <span class=n>go_package</span> <span class=o>=</span> <span class=s>&#34;github.com/bbengfort/notes/v1&#34;</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=kd>service</span> <span class=n>NoteService</span> <span class=p>{</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=k>rpc</span> <span class=n>Fetch</span><span class=p>(</span><span class=n>NoteFilter</span><span class=p>)</span> <span class=k>returns</span> <span class=p>(</span><span class=n>Notebook</span><span class=p>)</span> <span class=p>{};</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=k>rpc</span> <span class=n>Create</span><span class=p>(</span><span class=n>Note</span><span class=p>)</span> <span class=k>returns</span> <span class=p>(</span><span class=n>Notebook</span><span class=p>)</span> <span class=p>{};</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=p>}</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=kd>message</span> <span class=nc>Note</span> <span class=p>{</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=kt>uint64</span> <span class=n>id</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=kt>string</span> <span class=n>timestamp</span> <span class=o>=</span> <span class=mi>2</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=kt>string</span> <span class=n>author</span> <span class=o>=</span> <span class=mi>3</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=kt>string</span> <span class=n>text</span> <span class=o>=</span> <span class=mi>4</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=kt>bool</span> <span class=n>private</span> <span class=o>=</span> <span class=mi>5</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=p>}</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=kd>message</span> <span class=nc>NoteFilter</span> <span class=p>{</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=k>repeated</span> <span class=kt>uint64</span> <span class=n>ids</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=k>repeated</span> <span class=kt>string</span> <span class=n>author</span> <span class=o>=</span> <span class=mi>2</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=kt>string</span> <span class=n>before</span> <span class=o>=</span> <span class=mi>3</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=kt>string</span> <span class=n>after</span> <span class=o>=</span> <span class=mi>4</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=kt>bool</span> <span class=n>private</span> <span class=o>=</span> <span class=mi>5</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=p>}</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=kd>message</span> <span class=nc>Notebook</span> <span class=p>{</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=n>Error</span> <span class=n>error</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=k>repeated</span> <span class=n>Note</span> <span class=n>notes</span> <span class=o>=</span> <span class=mi>2</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=p>}</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=kd>message</span> <span class=nc>Error</span> <span class=p>{</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=kt>uint32</span> <span class=n>code</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=kt>string</span> <span class=kd>message</span> <span class=o>=</span> <span class=mi>2</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=p>}</span><span class=err>
</span></span></span></code></pre></div><p>So far, this is just a gRPC service definition. If we&rsquo;re working in a Go project, we can version our API and structure our project as follows:</p><pre tabindex=0><code>Workspace/go/src/github.com/bbengfort/notes
└── cmd
|   └── notes
|   |   └── main.go
├── go.mod
├── go.sum
└── proto
|   └── notes
|   |   └── v1
|   |   |   └── api.proto
</code></pre><p>Using this directory structure, generate the struct code and server and client interfaces using <code>protoc</code> with go and grpc plugins:</p><pre tabindex=0><code>$ protoc -I ./proto/ \
    --go_out=. --go_opt=module=github.com/bbengfort/notes \
    --go-grpc_out=. --go-grpc_opt=module=github.com/bbengfort/notes \
    proto/notes/v1/*.proto
</code></pre><blockquote><p><strong>NOTE:</strong> You&rsquo;ll have to install <code>protoc</code> (I did so with <code>brew</code>) and the go and grpc plugins (I used <code>go get</code>). See the <a href=https://grpc.io/docs/languages/go/quickstart/>gRPC Go Quickstart</a> for more information on the installation process.</p></blockquote><p>In this command the <code>-I</code> flag specifies where <code>protoc</code> can look for included protocol buffer files (e.g. if they&rsquo;re imported) - more on this later. The <code>--go_out</code> and <code>--go-grpc_out</code> flags specify where to write the generated go code and the <code>--go_opt=module=</code> and <code>--go-grpc_out=module</code> flags specify the root Go module. If you run this in the project root, e.g. <code>github.com/bbengfort/notes</code> then a <code>v1</code> directory will be created with <code>api.pb.go</code> and <code>api_grpc.pb.go</code> inside of it. This is because of the <code>option go_package = "github.com/bbengfort/notes/v1";</code> directive at the top of <code>api.proto</code> which resolves the output path based on all the module directives.</p><p><strong>Step 2</strong>: download includes files and install dependencies</p><p>In order to use the <code>grpc-gateway</code> and <code>openapiv2</code> protocol buffer plugins, we&rsquo;ll have to modify our proto file with <a href=https://developers.google.com/protocol-buffers/docs/proto#options>options</a> that allow us to specify how the REST API is defined and to supply information to the <code>swagger.json</code> generated OpenAPI v2 specification. Custom options are described in third party protocol buffer files that must be included when we generate our protocol buffers using the <code>-I</code> flag.</p><blockquote><p><strong>NOTE:</strong> I believe there is a way to download and &ldquo;install&rdquo; third party libraries into a global includes path, e.g. <code>/usr/local/include/google/protobuf</code> but I have to investigate this further.</p></blockquote><p>To simplify the use of <code>protoc</code> and to prevent dependency management issues, I just downloaded the needed third-party from <a href=https://github.com/johanbrandhorst/grpc-gateway-boilerplate/tree/master/third_party>grpc-gateway-boilerplate</a>. This appears to be a pattern in some of the repos I&rsquo;ve seen, adding them to a <code>third_party</code> directory, though I prefer to add them to a <code>include</code> directory. Your directory should now look like:</p><pre tabindex=0><code>Workspace/go/src/github.com/bbengfort/notes
└── cmd
|   └── notes
|   |   └── main.go
├── go.mod
├── go.sum
└── include
|   └── googleapis
|   |   ├── LICENSE
|   |   └── google
|   |   |   └── api
|   |   |   |   ├── annotations.proto
|   |   |   |   └── http.proto
|   |   |   └── rpc
|   |   |   |   ├── code.proto
|   |   |   |   ├── error_details.proto
|   |   |   |   └── status.proto
|   └── grpc-gateway
|   |   ├── LICENSE.txt
|   |   └── protoc-gen-openapiv2
|   |   |   └── options
|   |   |   |   ├── annotations.proto
|   |   |   |   └── openapiv2.proto
└── proto
|   └── notes
|   |   └── v1
|   |   |   └── api.proto
└── v1
|   ├── api.pb.go
|   └── api_grpc.pb.go
</code></pre><p>Finally <a href=https://github.com/grpc-ecosystem/grpc-gateway#installation>install the required grpc-gateway plugins</a> so that you have <code>protoc-gen-grpc-gateway</code> and <code>protoc-gen-openapiv2</code> in your <code>$GOBIN</code>.</p><p><strong>Step 3 (optional)</strong>: tell vscode where includes are</p><p>If you&rsquo;re using VSCode and the <a href="https://marketplace.visualstudio.com/items?itemName=zxh404.vscode-proto3">vscode-proto3 extension</a>, then I like to add the following directives to my workspace settings (<code>.vscode/settings.json</code>):</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;protoc&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;path&#34;</span><span class=p>:</span> <span class=s2>&#34;/usr/local/bin/protoc&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;compile_on_save&#34;</span><span class=p>:</span> <span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;options&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;-I=${workspaceRoot}/proto&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;-I=${workspaceRoot}/includes/googleapis&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;-I=${workspaceRoot}/includes/grpc-gateway&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>This prevents import error messages in your protocol buffers and enables autocomplete.</p><p><strong>Step 4</strong>: annotate our service</p><p>Finally, we&rsquo;re to the part we&rsquo;ve been waiting for - annotating our proto file with the REST and OpenAPI v2 options. At the beginning of <code>api.proto</code> add the following:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-protobuf data-lang=protobuf><span class=line><span class=cl><span class=n>syntax</span> <span class=o>=</span> <span class=s>&#34;proto3&#34;</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=kn>package</span> <span class=nn>notes</span><span class=o>.</span><span class=n>v1</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>option</span> <span class=n>go_package</span> <span class=o>=</span> <span class=s>&#34;github.com/bbengfort/notes/v1&#34;</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>import</span> <span class=s>&#34;google/api/annotations.proto&#34;</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>import</span> <span class=s>&#34;protoc-gen-openapiv2/options/annotations.proto&#34;</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>option</span> <span class=p>(</span><span class=n>grpc.gateway.protoc_gen_openapiv2.options.openapiv2_swagger</span><span class=p>)</span> <span class=o>=</span> <span class=p>{</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=n>info</span><span class=o>:</span> <span class=p>{</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>        <span class=n>title</span><span class=o>:</span> <span class=s>&#34;Notes&#34;</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>        <span class=n>version</span><span class=o>:</span> <span class=s>&#34;1.0&#34;</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>        <span class=n>contact</span><span class=o>:</span> <span class=p>{</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>            <span class=n>name</span><span class=o>:</span> <span class=s>&#34;bbengfort&#34;</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>            <span class=n>url</span><span class=o>:</span> <span class=s>&#34;https://github.com/bbengfort/notes&#34;</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>            <span class=n>email</span><span class=o>:</span> <span class=s>&#34;info@bengfort.com&#34;</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>        <span class=p>};</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>        <span class=n>license</span><span class=o>:</span> <span class=p>{</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>            <span class=n>name</span><span class=o>:</span> <span class=s>&#34;BSD 3-Clause License&#34;</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>            <span class=n>url</span><span class=o>:</span> <span class=s>&#34;https://github.com/bbengfort/notes/LICENSE&#34;</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>        <span class=p>};</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=p>};</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=n>schemes</span><span class=o>:</span> <span class=n>HTTP</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=n>schemes</span><span class=o>:</span> <span class=n>HTTPS</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=n>consumes</span><span class=o>:</span> <span class=s>&#34;application/json&#34;</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=n>produces</span><span class=o>:</span> <span class=s>&#34;application/json&#34;</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=p>};</span><span class=err>
</span></span></span></code></pre></div><p>When the <code>openapiv2</code> plugin generates a <code>swagger.json</code> file, the information in this option will be used to populate the <code>info</code>, <code>schemes</code>, <code>consumes</code>, and <code>produces</code> fields of the specificiation. This will both influence the information in the generated documentation as well as make it easier to create a live server.</p><p>Next we must update the service definition to map gRPC services to REST API calls:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-protobuf data-lang=protobuf><span class=line><span class=cl><span class=kd>service</span> <span class=n>NoteService</span> <span class=p>{</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=k>rpc</span> <span class=n>Fetch</span><span class=p>(</span><span class=n>NoteFilter</span><span class=p>)</span> <span class=k>returns</span> <span class=p>(</span><span class=n>Notebook</span><span class=p>)</span> <span class=p>{</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>        <span class=k>option</span> <span class=p>(</span><span class=n>google.api.http</span><span class=p>)</span> <span class=o>=</span> <span class=p>{</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>            <span class=n>get</span><span class=o>:</span> <span class=s>&#34;/api/v1/notes&#34;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>        <span class=p>};</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=p>};</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=k>rpc</span> <span class=n>Create</span><span class=p>(</span><span class=n>Note</span><span class=p>)</span> <span class=k>returns</span> <span class=p>(</span><span class=n>Notebook</span><span class=p>)</span> <span class=p>{</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>        <span class=k>option</span> <span class=p>(</span><span class=n>google.api.http</span><span class=p>)</span> <span class=o>=</span> <span class=p>{</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>            <span class=n>post</span><span class=o>:</span> <span class=s>&#34;/api/v1/notes&#34;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>            <span class=n>body</span><span class=o>:</span> <span class=s>&#34;*&#34;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>        <span class=p>};</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=p>};</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=p>}</span><span class=err>
</span></span></span></code></pre></div><p>These options specify that the <code>Fetch</code> RPC can be accessed with a <code>GET</code> request to <code>/api/v1/notes</code> and that the <code>Create</code> RPC uses <code>POST</code> to the same endpoint. Note that the <code>body: "*"</code> flag ensures that the request body is included in endpoint.</p><p><strong>Step 5</strong>: generate swagger spec and serve</p><p>In the final step of this post, we&rsquo;ll use the <code>openapiv2</code> plugin to generate the swagger json specification and use the swagger-ui docker image to serve some static documentation.</p><pre tabindex=0><code>protoc -I ./proto/ \
    -I include/googleapis -I include/grpc-gateway \
    --go_out=. --go_opt=module=github.com/bbengfort/notes \
    --go-grpc_out=. --go-grpc_opt=module=github.com/bbengfort/notes \
    --openapiv2_out ./openapiv2 --openapiv2_opt logtostderr=true \
    proto/notes/v1/*.proto
</code></pre><p>This <code>protoc</code> command has been updated to include the third party protocol buffer files and also adds the <code>openapiv2</code> plugin, writing a specification file at <code>openapiv2/notes/v1/api.swagger.json</code> (note you may have to make the <code>openapiv2</code> directory before running this command).</p><p>To <a href=https://swagger.io/docs/open-source-tools/swagger-ui/usage/installation/>serve the static swagger-ui docs</a>, I used Docker as follows:</p><pre tabindex=0><code>$ docker run -p 80:8080 \
    -e SWAGGER_JSON=/openapiv2/notes/v1/api.swagger.json \
    -v $PWD/openapiv2/:/openapiv2 \
    swaggerapi/swagger-ui
</code></pre><p>This will pull the <code>swaggerapi/swagger-ui</code> image from DockerHub when you run it for the first time. You can then view the docs at <code>http://localhost/</code>:</p><p><img loading=lazy src=/images/2021-01-21-swagger-notes.png alt="Swagger UI"></p><p>The next steps are to use <code>grpc-gateway</code> to create a server that does both gRPC hosting and a JSON REST API - complete with live Swagger documentation and styling.</p></div><footer class=post-footer><ul class=post-tags></ul><nav class=paginav><a class=prev href=https://bbengfort.github.io/2021/01/new-hugo-theme/><span class=title>« Prev</span><br><span>New Hugo Theme</span></a>
<a class=next href=https://bbengfort.github.io/2020/12/self-signed-ca/><span class=title>Next »</span><br><span>Self Signed CA</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2023 <a href=https://bbengfort.github.io>Libelli</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>