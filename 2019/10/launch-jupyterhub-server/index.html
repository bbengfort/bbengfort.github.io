<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Launching a JupyterHub Instance | Libelli</title>
<meta name=keywords content><meta name=description content="In this post I walk through the steps of creating a multi-user JupyterHub sever running on an AWS Ubuntu 18.04 instance. There are many ways of setting up JupyterHub including using Docker and Kubernetes - but this is a pretty staight forward mechanism that doesn&rsquo;t have too many moving parts such as TLS termination proxies etc. I think of this as the baseline setup.
Note that this setup has a few pros or cons depending on how you look at them."><meta name=author content="Benjamin Bengfort"><link rel=canonical href=https://bbengfort.github.io/2019/10/launch-jupyterhub-server/><link crossorigin=anonymous href=/assets/css/stylesheet.fc220c15db4aef0318bbf30adc45d33d4d7c88deff3238b23eb255afdc472ca6.css integrity="sha256-/CIMFdtK7wMYu/MK3EXTPU18iN7/MjiyPrJVr9xHLKY=" rel="preload stylesheet" as=style><link rel=icon href=https://bbengfort.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://bbengfort.github.io/icon.png><link rel=icon type=image/png sizes=32x32 href=https://bbengfort.github.io/icon.png><link rel=apple-touch-icon href=https://bbengfort.github.io/apple-touch-icon-precomposed.png><link rel=mask-icon href=https://bbengfort.github.io/icon.png><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://bbengfort.github.io/2019/10/launch-jupyterhub-server/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-D3BE7EHHVP"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-D3BE7EHHVP")}</script><meta property="og:title" content="Launching a JupyterHub Instance"><meta property="og:description" content="In this post I walk through the steps of creating a multi-user JupyterHub sever running on an AWS Ubuntu 18.04 instance. There are many ways of setting up JupyterHub including using Docker and Kubernetes - but this is a pretty staight forward mechanism that doesn&rsquo;t have too many moving parts such as TLS termination proxies etc. I think of this as the baseline setup.
Note that this setup has a few pros or cons depending on how you look at them."><meta property="og:type" content="article"><meta property="og:url" content="https://bbengfort.github.io/2019/10/launch-jupyterhub-server/"><meta property="og:image" content="https://bbengfort.github.io/bear.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2019-10-09T16:40:08+00:00"><meta property="article:modified_time" content="2019-10-09T16:40:08+00:00"><meta property="og:site_name" content="Libelli"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://bbengfort.github.io/bear.png"><meta name=twitter:title content="Launching a JupyterHub Instance"><meta name=twitter:description content="In this post I walk through the steps of creating a multi-user JupyterHub sever running on an AWS Ubuntu 18.04 instance. There are many ways of setting up JupyterHub including using Docker and Kubernetes - but this is a pretty staight forward mechanism that doesn&rsquo;t have too many moving parts such as TLS termination proxies etc. I think of this as the baseline setup.
Note that this setup has a few pros or cons depending on how you look at them."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://bbengfort.github.io/posts/"},{"@type":"ListItem","position":2,"name":"Launching a JupyterHub Instance","item":"https://bbengfort.github.io/2019/10/launch-jupyterhub-server/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Launching a JupyterHub Instance","name":"Launching a JupyterHub Instance","description":"In this post I walk through the steps of creating a multi-user JupyterHub sever running on an AWS Ubuntu 18.04 instance. There are many ways of setting up JupyterHub including using Docker and Kubernetes - but this is a pretty staight forward mechanism that doesn\u0026rsquo;t have too many moving parts such as TLS termination proxies etc. I think of this as the baseline setup.\nNote that this setup has a few pros or cons depending on how you look at them.\n","keywords":[],"articleBody":"In this post I walk through the steps of creating a multi-user JupyterHub sever running on an AWS Ubuntu 18.04 instance. There are many ways of setting up JupyterHub including using Docker and Kubernetes - but this is a pretty staight forward mechanism that doesn’t have too many moving parts such as TLS termination proxies etc. I think of this as the baseline setup.\nNote that this setup has a few pros or cons depending on how you look at them.\nJupyterHub is responsible for TLS and you need to create certificates for it. Users cannot install packages using !conda install or !pip install. Users cannot create environments and use them. PAM users are created, so users can SSH into the machine. This post serves as a general sketch of how to get a production ready JupyterHub server up and running for multiple users.\nStep 1: Launch an instance Use the method of your choice to create an AWS instance in a VPC that has access to the Internet. A couple of notes on the instance creation process:\nI used the Ubuntu 18.04 HVM LTS as the base AMI Ensure the instance is in a security group that allows ports 22 and 443 Ensure you have SSH access to the instance Ensure the instance has enough memory, compute, and disk for your intended workload Next ensure the instance can be reachable by a DNS name. This is required for TLS to work. There are a few ways to do this, but the way I did it was to:\nCreate an elastic IP address (EIP) and assign it to the instance Create an A record in route53 mapping the domain name to the EIP At this point you should be able to SSH into your instance via the domain name. If so, you’re good to go for the next steps.\nStep 2: Install Anaconda I chose to use Anaconda to facilitate data science workloads for this installation. Anaconda has its pros and cons on a system level install, but one of the implications was that users could not install their own packages. Additionally, I had to jump through some hoops to get the server running with systemd. After this experience, vanilla Python might be a better choice, to be frank.\nFirst create a system user for Anaconda and add the ubuntu user to the group:\n$ sudo useradd -r anaconda $ sudo usermod -a -G anaconda ubuntu Next install Anaconda as follows:\nSelect distribution from Anaconda Distributions\nCopy 64-bit (x86) installer URL\nDownload, verify integrity, and execute the script\n$ curl -O https://repo.anaconda.com/archive/Anaconda3-2019.07-Linux-x86_64.sh $ sha256sum Anaconda3-2019.07-Linux-x86_64.sh 69581cf739365ec7fb95608eef694ba959d7d33b36eb961953f2b82cb25bdf5a Anaconda3-2019.07-Linux-x86_64.sh $ sudo bash Anaconda3-2019.07-Linux-x86_64.sh Accept the user agreement\nInstall to /opt/anaconda\nUpdate permissions of /opt/anaconda\n$ sudo chown -R anaconda:anaconda /opt/anaconda $ sudo chmod -R 775 /opt/anaconda These permissions should give the ubuntu user the ability to install packages to anaconda, but not other users. Other users should be able to execute anaconda commands but not modify the anaconda install. If they want to install their own packages, they’ll have to create a virtual environment in their home directory.\nOptional step: ensure Anaconda is available for new users This is an optional step, but because Anaconda relies heavily on the shell for configuration, I ensured that any new users would have access to Anaconda by appending the following to /etc/skel/.bashrc:\n# \u003e\u003e\u003e conda initialize \u003e\u003e\u003e # !! Contents within this block are managed by 'conda init' !! __conda_setup=\"$('/opt/anaconda/bin/conda' 'shell.bash' 'hook' 2\u003e /dev/null)\" if [ $? -eq 0 ]; then eval \"$__conda_setup\" else if [ -f \"/opt/anaconda/etc/profile.d/conda.sh\" ]; then . \"/opt/anaconda/etc/profile.d/conda.sh\" else export PATH=\"/opt/anaconda/bin:$PATH\" fi fi unset __conda_setup # \u003c\u003c\u003c conda initialize \u003c\u003c\u003c Note that I also added this to /root/.bashrc so that when I executed commands with sudo su, Anaconda was available to the root user.\nStep 3: Install JupyterHub Install the required packages using conda and pip:\n(base) $ conda install -c conda-forge jupyterhub (base) $ conda install notebook (base) $ pip install jupyterhub-systemdspawner Make sure that pip is associated with the conda environment and not with the default Python installation!\nAs with Anaconda, we’ll create a jupyterhub system user and working directory for the server.\n$ sudo useradd -r jupyterhub $ sudo usermod -a -G jupyterhub ubuntu $ sudo mkdir /srv/jupyterhub $ sudo chown -R jupyterhub:jupyterhub /srv/jupyterhub Note, however, that we’ll run JupyterHub as a privileged user rather than as this user, but it simplifies the management of files a bit to do it this way.\nStep 4: Create LetsEncrypt certs At this point you’ll have to create certificates for the TLS endpoint. I prefer to use certbot and LetsEncrypt since it makes things so easy. Note that you’ll also have to implement a verification method to be granted the certificates (to prove you own the domain) which will also be true for renewal. I’ll be using route53 verification in this example.\nInstall certbot (instructions from the certbot website)\n$ sudo apt-get update $ sudo apt-get install software-properties-common $ sudo add-apt-repository universe $ sudo add-apt-repository ppa:certbot/certbot $ sudo apt-get update $ sudo apt-get install certbot python3-certbot-dns-route53 Ensure that your AWS credentials are correctly configured for boto3 and that sudo can access them (e.g. not in the environment), then perform the verification. You’ll need to submit an email address, agree to the license, and choose if you want the EFF electronic newsletter.\n$ sudo certbot certonly --dns-route53 -d jupyter.mydomain.com Ensure that crontab is setup to automatically renew the certs.\n$ sudo certbot renew --dry-run $ cat /etc/cron.d/certbot Note that we could also setup JupyterHub behind a proxy like Traefik or nginx, which would terminate the TLS itself and is perhaps a bit more easy to automatically configure than route53. I recommend this method particularly if you’re not on AWS.\nStep 5: Configure JupyterHub Create the jupyterhub configuration file and move it to the recommended system configuration location as follows:\n$ jupyterhub --generate-config $ sudo mkdir /etc/jupyterhub $ sudo mv jupyterhub_config.py /etc/jupyterhub There is a lot of commented out configuration details, but the important configurations to me are as follows:\n# Set the JupyterHub bind URL, protocol and port c.JupyterHub.bind_url = 'https://0.0.0.0:443' # Save the cookie secret file in the jupyterhub working directory c.JupyterHub.cookie_secret_file = '/srv/jupyterhub/cookie_secret' # Save the database in the jupyterhub working directory c.JupyterHub.db_url = 'sqlite:////srv/jupyterhub/jupyterhub.sqlite' # Set the hub bind url for all jupyter-single user instances c.JupyterHub.hub_bind_url = 'http://127.0.0.1:8081' # Store the pid file in the jupyterhub working directory c.JupyterHub.pid_file = '/srv/jupyterhub/jupyterhub.pid' # Ensure that notebooks are shutdown when users log out so that notebooks # are cleaned up releasing their memory. Note this is also a helpful way # to do support: just have them log out and log back in again! c.JupyterHub.shutdown_on_logout = True # We're using the SystemdSpawner c.JupyterHub.spawner_class = 'systemdspawner.SystemdSpawner' # Specify the locations of the letsencrypt certs c.JupyterHub.ssl_cert = '/etc/letsencrypt/live/jupyter.mydomain.com/fullchain.pem' c.JupyterHub.ssl_key = '/etc/letsencrypt/live/jupyter.mydomain.com/privkey.pem' # Set limits on the compute resources users have access to c.SystemdSpawner.cpu_limit = 3.0 c.SystemdSpawner.isolate_tmp = True c.SystemdSpawner.isolate_devices = True c.SystemdSpawner.disable_user_sudo = True c.SystemdSpawner.mem_limit = '8G' # Set any environment variables you'd like your users to have access to. # Very helpful for things like $NLTK_DATA or other Python resources. c.Spawner.environment = { \"MY_ENV_VAR\": \"fo\" } # Determine who can create new user accounts c.Authenticator.admin_users = set(['ubuntu', 'admin']) Create a new user and password for the admin user:\n$ sudo adduser admin Enter the password and details for the admin user – this will give you admin access to the JupyterHub server and allow you to create new users online.\nAt this point, as the root user you should be able to run:\n$ jupyterhub -f /etc/jupyterhub/jupyterhub_config.py You should be able to see the login screen and login as the admin user. You should also be able to create new users from the admin page.\nStep 6: Run JupyterHub as a systemd service Because anaconda needs to be initialized and the environment modified to support it, the systemd service needs to be run from a bash script. Add the following to /usr/local/bin/run_jupyterhub.sh and make it executable.\n#!/bin/bash # \u003e\u003e\u003e conda initialize \u003e\u003e\u003e # !! Contents within this block are managed by 'conda init' !! __conda_setup=\"$('/opt/anaconda/bin/conda' 'shell.bash' 'hook' 2\u003e /dev/null)\" if [ $? -eq 0 ]; then eval \"$__conda_setup\" else if [ -f \"/opt/anaconda/etc/profile.d/conda.sh\" ]; then . \"/opt/anaconda/etc/profile.d/conda.sh\" else export PATH=\"/opt/anaconda/bin:$PATH\" fi fi unset __conda_setup # \u003c\u003c\u003c conda initialize \u003c\u003c\u003c # Run the JupyterHub service with the system configuration jupyterhub -f /etc/jupyterhub/jupyterhub_config.py Create a systemd service by writing the following into /etc/systemd/system/jupyterhub.service:\n[Unit] Description=JupyterHub Documentation=https://jupyterhub.readthedocs.io/en/stable/ [Service] Type=simple After=network.target Restart=always RestartSec=10 WorkingDirectory=/srv/jupyterhub ExecStart=/usr/local/bin/run_jupyterhub.sh StandardOutput=syslog StandardError=syslog SyslogIdentifier=jupyterhub [Install] WantedBy=multi-user.target You can now enable and start the server as follows:\n$ sudo systemctl enable jupyterhub.service $ sudo systemctl start jupyterhub.service You should now be able to go to the server and access JupyterHub without running it specifically as the user. To diagnose issues, use journalctl as follows:\n$ sudo journalctl -u jupyterhub.service This will open up the log file and tell you if anything went wrong.\nStep 7: Handle Logging Our systemd service writes all output to the syslog. By default we can access the logs using journalctl. However, to make debugging easier, we can use rsyslog to write the logs into a file. Add the following in /etc/rsyslog/jupyterhub.conf:\nif $programname == 'jupyterhub' then /var/log/jupyterhub/access.log \u0026 stop Note also that you might have to add a priority to the configuration, e.g. 22-jupyterhub.conf to ensure that rsyslog executes it correctly. Create the logging directory and give it the correct permissions, then restart rsyslog:\n$ mkdir /var/log/jupyterhub $ chown root:syslog /var/log/jupyterhub $ chmod 775 /var/log/jupyterhub $ systemctl restart rsyslog.service To make sure the logs don’t get too large, add the following to /etc/logrotate.d/jupyterhub.conf:\n/var/log/jupyterhub/access.log { daily rotate 15 size 50M missingok notifempty compress delaycompress dateext dateformat -%Y-%m-%d create 0644 root root } This will ensure that the logs are compressed and rotated daily and that they will be deleted after 15 days.\n","wordCount":"1644","inLanguage":"en","image":"https://bbengfort.github.io/bear.png","datePublished":"2019-10-09T16:40:08Z","dateModified":"2019-10-09T16:40:08Z","author":{"@type":"Person","name":"Benjamin Bengfort"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://bbengfort.github.io/2019/10/launch-jupyterhub-server/"},"publisher":{"@type":"Organization","name":"Libelli","logo":{"@type":"ImageObject","url":"https://bbengfort.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://bbengfort.github.io/ accesskey=h title="Libelli (Alt + H)"><img src=https://bbengfort.github.io/icon.png alt aria-label=logo height=35>Libelli</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://bbengfort.github.io/archive/ title=archive><span>archive</span></a></li><li><a href=https://bbengfort.github.io/categories/ title=categories><span>categories</span></a></li><li><a href=https://bbengfort.github.io/search/ title="search (Alt + /)" accesskey=/><span>search</span></a></li><li><a href=https://bbengfort.github.io/about/ title=about><span>about</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://bbengfort.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://bbengfort.github.io/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">Launching a JupyterHub Instance</h1><div class=post-meta><span title='2019-10-09 16:40:08 +0000 UTC'>October 9, 2019</span>&nbsp;·&nbsp;8 min&nbsp;·&nbsp;1644 words&nbsp;·&nbsp;Benjamin Bengfort&nbsp;|&nbsp;<a href=https://github.com/bbengfort/bbengfort.github.io/tree/main/content/posts/2019-10-09-launch-jupyterhub-server.md rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><div class=post-content><p>In this post I walk through the steps of creating a multi-user JupyterHub sever running on an AWS Ubuntu 18.04 instance. There are many ways of setting up JupyterHub including using Docker and Kubernetes - but this is a pretty staight forward mechanism that doesn&rsquo;t have too many moving parts such as TLS termination proxies etc. I think of this as the baseline setup.</p><p>Note that this setup has a few pros or cons depending on how you look at them.</p><ol><li>JupyterHub is responsible for TLS and you need to create certificates for it.</li><li>Users cannot install packages using <code>!conda install</code> or <code>!pip install</code>.</li><li>Users cannot create environments and use them.</li><li>PAM users are created, so users can SSH into the machine.</li></ol><p>This post serves as a general sketch of how to get a production ready JupyterHub server up and running for multiple users.</p><h3 id=step-1-launch-an-instance>Step 1: Launch an instance<a hidden class=anchor aria-hidden=true href=#step-1-launch-an-instance>#</a></h3><p>Use the method of your choice to create an AWS instance in a VPC that has access to the Internet. A couple of notes on the instance creation process:</p><ul><li>I used the Ubuntu 18.04 HVM LTS as the base AMI</li><li>Ensure the instance is in a security group that allows ports 22 and 443</li><li>Ensure you have SSH access to the instance</li><li>Ensure the instance has enough memory, compute, and disk for your intended workload</li></ul><p>Next ensure the instance can be reachable by a DNS name. This is required for TLS to work. There are a few ways to do this, but the way I did it was to:</p><ul><li>Create an elastic IP address (EIP) and assign it to the instance</li><li>Create an A record in route53 mapping the domain name to the EIP</li></ul><p>At this point you should be able to SSH into your instance via the domain name. If so, you&rsquo;re good to go for the next steps.</p><h3 id=step-2-install-anaconda>Step 2: Install Anaconda<a hidden class=anchor aria-hidden=true href=#step-2-install-anaconda>#</a></h3><p>I chose to use Anaconda to facilitate data science workloads for this installation. Anaconda has its pros and cons on a system level install, but one of the implications was that users could not install their own packages. Additionally, I had to jump through some hoops to get the server running with systemd. After this experience, vanilla Python might be a better choice, to be frank.</p><p>First create a system user for Anaconda and add the ubuntu user to the group:</p><pre tabindex=0><code>$ sudo useradd -r anaconda
$ sudo usermod -a -G anaconda ubuntu
</code></pre><p>Next install Anaconda as follows:</p><ol><li><p>Select distribution from <a href=https://www.anaconda.com/distribution/>Anaconda Distributions</a></p></li><li><p>Copy 64-bit (x86) installer URL</p></li><li><p>Download, verify integrity, and execute the script</p><pre tabindex=0><code>$ curl -O https://repo.anaconda.com/archive/Anaconda3-2019.07-Linux-x86_64.sh
$ sha256sum Anaconda3-2019.07-Linux-x86_64.sh
69581cf739365ec7fb95608eef694ba959d7d33b36eb961953f2b82cb25bdf5a  Anaconda3-2019.07-Linux-x86_64.sh
$ sudo bash Anaconda3-2019.07-Linux-x86_64.sh
</code></pre></li><li><p>Accept the user agreement</p></li><li><p>Install to <code>/opt/anaconda</code></p></li><li><p>Update permissions of <code>/opt/anaconda</code></p><pre tabindex=0><code>$ sudo chown -R anaconda:anaconda /opt/anaconda
$ sudo chmod -R 775 /opt/anaconda
</code></pre></li></ol><p>These permissions should give the ubuntu user the ability to install packages to anaconda, but not other users. Other users should be able to execute anaconda commands but not modify the anaconda install. If they want to install their own packages, they&rsquo;ll have to create a virtual environment in their home directory.</p><h4 id=optional-step-ensure-anaconda-is-available-for-new-users>Optional step: ensure Anaconda is available for new users<a hidden class=anchor aria-hidden=true href=#optional-step-ensure-anaconda-is-available-for-new-users>#</a></h4><p>This is an optional step, but because Anaconda relies heavily on the shell for configuration, I ensured that any new users would have access to Anaconda by appending the following to <code>/etc/skel/.bashrc</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># &gt;&gt;&gt; conda initialize &gt;&gt;&gt;</span>
</span></span><span class=line><span class=cl><span class=c1># !! Contents within this block are managed by &#39;conda init&#39; !!</span>
</span></span><span class=line><span class=cl><span class=nv>__conda_setup</span><span class=o>=</span><span class=s2>&#34;</span><span class=k>$(</span><span class=s1>&#39;/opt/anaconda/bin/conda&#39;</span> <span class=s1>&#39;shell.bash&#39;</span> <span class=s1>&#39;hook&#39;</span> 2&gt; /dev/null<span class=k>)</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>[</span> <span class=nv>$?</span> -eq <span class=m>0</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>    <span class=nb>eval</span> <span class=s2>&#34;</span><span class=nv>$__conda_setup</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=k>else</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>[</span> -f <span class=s2>&#34;/opt/anaconda/etc/profile.d/conda.sh&#34;</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>        . <span class=s2>&#34;/opt/anaconda/etc/profile.d/conda.sh&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span>
</span></span><span class=line><span class=cl>        <span class=nb>export</span> <span class=nv>PATH</span><span class=o>=</span><span class=s2>&#34;/opt/anaconda/bin:</span><span class=nv>$PATH</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>fi</span>
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span><span class=line><span class=cl><span class=nb>unset</span> __conda_setup
</span></span><span class=line><span class=cl><span class=c1># &lt;&lt;&lt; conda initialize &lt;&lt;&lt;</span>
</span></span></code></pre></div><p>Note that I also added this to <code>/root/.bashrc</code> so that when I executed commands with <code>sudo su</code>, Anaconda was available to the root user.</p><h3 id=step-3-install-jupyterhub>Step 3: Install JupyterHub<a hidden class=anchor aria-hidden=true href=#step-3-install-jupyterhub>#</a></h3><p>Install the required packages using <code>conda</code> and <code>pip</code>:</p><pre tabindex=0><code>(base) $ conda install -c conda-forge jupyterhub
(base) $ conda install notebook
(base) $ pip install jupyterhub-systemdspawner
</code></pre><p>Make sure that <code>pip</code> is associated with the conda environment and not with the default Python installation!</p><p>As with Anaconda, we&rsquo;ll create a jupyterhub system user and working directory for the server.</p><pre tabindex=0><code>$ sudo useradd -r jupyterhub
$ sudo usermod -a -G jupyterhub ubuntu
$ sudo mkdir /srv/jupyterhub
$ sudo chown -R jupyterhub:jupyterhub /srv/jupyterhub
</code></pre><p>Note, however, that we&rsquo;ll run JupyterHub as a privileged user rather than as this user, but it simplifies the management of files a bit to do it this way.</p><h3 id=step-4-create-letsencrypt-certs>Step 4: Create LetsEncrypt certs<a hidden class=anchor aria-hidden=true href=#step-4-create-letsencrypt-certs>#</a></h3><p>At this point you&rsquo;ll have to create certificates for the TLS endpoint. I prefer to use <a href=https://certbot.eff.org/>certbot</a> and <a href=https://letsencrypt.org/>LetsEncrypt</a> since it makes things so easy. Note that you&rsquo;ll also have to implement a verification method to be granted the certificates (to prove you own the domain) which will also be true for renewal. I&rsquo;ll be using <a href=https://certbot-dns-route53.readthedocs.io/en/stable/>route53 verification</a> in this example.</p><p>Install certbot (instructions from the certbot website)</p><pre tabindex=0><code>$ sudo apt-get update
$ sudo apt-get install software-properties-common
$ sudo add-apt-repository universe
$ sudo add-apt-repository ppa:certbot/certbot
$ sudo apt-get update
$ sudo apt-get install certbot python3-certbot-dns-route53
</code></pre><p>Ensure that your AWS credentials are correctly configured for boto3 and that sudo can access them (e.g. not in the environment), then perform the verification. You&rsquo;ll need to submit an email address, agree to the license, and choose if you want the EFF electronic newsletter.</p><pre tabindex=0><code>$ sudo certbot certonly --dns-route53 -d jupyter.mydomain.com
</code></pre><p>Ensure that crontab is setup to automatically renew the certs.</p><pre tabindex=0><code>$ sudo certbot renew --dry-run
$ cat /etc/cron.d/certbot
</code></pre><p>Note that we could also setup JupyterHub behind a proxy like Traefik or nginx, which would terminate the TLS itself and is perhaps a bit more easy to automatically configure than route53. I recommend this method particularly if you&rsquo;re not on AWS.</p><h3 id=step-5-configure-jupyterhub>Step 5: Configure JupyterHub<a hidden class=anchor aria-hidden=true href=#step-5-configure-jupyterhub>#</a></h3><p>Create the jupyterhub configuration file and move it to the recommended system configuration location as follows:</p><pre tabindex=0><code>$ jupyterhub --generate-config
$ sudo mkdir /etc/jupyterhub
$ sudo mv jupyterhub_config.py /etc/jupyterhub
</code></pre><p>There is a lot of commented out configuration details, but the important configurations to me are as follows:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># Set the JupyterHub bind URL, protocol and port</span>
</span></span><span class=line><span class=cl><span class=n>c</span><span class=o>.</span><span class=n>JupyterHub</span><span class=o>.</span><span class=n>bind_url</span> <span class=o>=</span> <span class=s1>&#39;https://0.0.0.0:443&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Save the cookie secret file in the jupyterhub working directory</span>
</span></span><span class=line><span class=cl><span class=n>c</span><span class=o>.</span><span class=n>JupyterHub</span><span class=o>.</span><span class=n>cookie_secret_file</span> <span class=o>=</span> <span class=s1>&#39;/srv/jupyterhub/cookie_secret&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Save the database in the jupyterhub working directory</span>
</span></span><span class=line><span class=cl><span class=n>c</span><span class=o>.</span><span class=n>JupyterHub</span><span class=o>.</span><span class=n>db_url</span> <span class=o>=</span> <span class=s1>&#39;sqlite:////srv/jupyterhub/jupyterhub.sqlite&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Set the hub bind url for all jupyter-single user instances</span>
</span></span><span class=line><span class=cl><span class=n>c</span><span class=o>.</span><span class=n>JupyterHub</span><span class=o>.</span><span class=n>hub_bind_url</span> <span class=o>=</span> <span class=s1>&#39;http://127.0.0.1:8081&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Store the pid file in the jupyterhub working directory</span>
</span></span><span class=line><span class=cl><span class=n>c</span><span class=o>.</span><span class=n>JupyterHub</span><span class=o>.</span><span class=n>pid_file</span> <span class=o>=</span> <span class=s1>&#39;/srv/jupyterhub/jupyterhub.pid&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Ensure that notebooks are shutdown when users log out so that notebooks</span>
</span></span><span class=line><span class=cl><span class=c1># are cleaned up releasing their memory. Note this is also a helpful way</span>
</span></span><span class=line><span class=cl><span class=c1># to do support: just have them log out and log back in again!</span>
</span></span><span class=line><span class=cl><span class=n>c</span><span class=o>.</span><span class=n>JupyterHub</span><span class=o>.</span><span class=n>shutdown_on_logout</span> <span class=o>=</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># We&#39;re using the SystemdSpawner</span>
</span></span><span class=line><span class=cl><span class=n>c</span><span class=o>.</span><span class=n>JupyterHub</span><span class=o>.</span><span class=n>spawner_class</span> <span class=o>=</span> <span class=s1>&#39;systemdspawner.SystemdSpawner&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Specify the locations of the letsencrypt certs</span>
</span></span><span class=line><span class=cl><span class=n>c</span><span class=o>.</span><span class=n>JupyterHub</span><span class=o>.</span><span class=n>ssl_cert</span> <span class=o>=</span> <span class=s1>&#39;/etc/letsencrypt/live/jupyter.mydomain.com/fullchain.pem&#39;</span>
</span></span><span class=line><span class=cl><span class=n>c</span><span class=o>.</span><span class=n>JupyterHub</span><span class=o>.</span><span class=n>ssl_key</span> <span class=o>=</span> <span class=s1>&#39;/etc/letsencrypt/live/jupyter.mydomain.com/privkey.pem&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Set limits on the compute resources users have access to</span>
</span></span><span class=line><span class=cl><span class=n>c</span><span class=o>.</span><span class=n>SystemdSpawner</span><span class=o>.</span><span class=n>cpu_limit</span> <span class=o>=</span> <span class=mf>3.0</span>
</span></span><span class=line><span class=cl><span class=n>c</span><span class=o>.</span><span class=n>SystemdSpawner</span><span class=o>.</span><span class=n>isolate_tmp</span> <span class=o>=</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl><span class=n>c</span><span class=o>.</span><span class=n>SystemdSpawner</span><span class=o>.</span><span class=n>isolate_devices</span> <span class=o>=</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl><span class=n>c</span><span class=o>.</span><span class=n>SystemdSpawner</span><span class=o>.</span><span class=n>disable_user_sudo</span> <span class=o>=</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl><span class=n>c</span><span class=o>.</span><span class=n>SystemdSpawner</span><span class=o>.</span><span class=n>mem_limit</span> <span class=o>=</span> <span class=s1>&#39;8G&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Set any environment variables you&#39;d like your users to have access to.</span>
</span></span><span class=line><span class=cl><span class=c1># Very helpful for things like $NLTK_DATA or other Python resources.</span>
</span></span><span class=line><span class=cl><span class=n>c</span><span class=o>.</span><span class=n>Spawner</span><span class=o>.</span><span class=n>environment</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;MY_ENV_VAR&#34;</span><span class=p>:</span> <span class=s2>&#34;fo&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Determine who can create new user accounts</span>
</span></span><span class=line><span class=cl><span class=n>c</span><span class=o>.</span><span class=n>Authenticator</span><span class=o>.</span><span class=n>admin_users</span> <span class=o>=</span> <span class=nb>set</span><span class=p>([</span><span class=s1>&#39;ubuntu&#39;</span><span class=p>,</span> <span class=s1>&#39;admin&#39;</span><span class=p>])</span>
</span></span></code></pre></div><p>Create a new user and password for the admin user:</p><pre tabindex=0><code>$ sudo adduser admin
</code></pre><p>Enter the password and details for the admin user &ndash; this will give you admin access to the JupyterHub server and allow you to create new users online.</p><p>At this point, as the root user you should be able to run:</p><pre tabindex=0><code>$ jupyterhub -f /etc/jupyterhub/jupyterhub_config.py
</code></pre><p>You should be able to see the login screen and login as the admin user. You should also be able to create new users from the admin page.</p><h3 id=step-6-run-jupyterhub-as-a-systemd-service>Step 6: Run JupyterHub as a systemd service<a hidden class=anchor aria-hidden=true href=#step-6-run-jupyterhub-as-a-systemd-service>#</a></h3><p>Because anaconda needs to be initialized and the environment modified to support it, the systemd service needs to be run from a bash script. Add the following to <code>/usr/local/bin/run_jupyterhub.sh</code> and make it executable.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=cp>#!/bin/bash
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=c1># &gt;&gt;&gt; conda initialize &gt;&gt;&gt;</span>
</span></span><span class=line><span class=cl><span class=c1># !! Contents within this block are managed by &#39;conda init&#39; !!</span>
</span></span><span class=line><span class=cl><span class=nv>__conda_setup</span><span class=o>=</span><span class=s2>&#34;</span><span class=k>$(</span><span class=s1>&#39;/opt/anaconda/bin/conda&#39;</span> <span class=s1>&#39;shell.bash&#39;</span> <span class=s1>&#39;hook&#39;</span> 2&gt; /dev/null<span class=k>)</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>[</span> <span class=nv>$?</span> -eq <span class=m>0</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>    <span class=nb>eval</span> <span class=s2>&#34;</span><span class=nv>$__conda_setup</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=k>else</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>[</span> -f <span class=s2>&#34;/opt/anaconda/etc/profile.d/conda.sh&#34;</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>        . <span class=s2>&#34;/opt/anaconda/etc/profile.d/conda.sh&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span>
</span></span><span class=line><span class=cl>        <span class=nb>export</span> <span class=nv>PATH</span><span class=o>=</span><span class=s2>&#34;/opt/anaconda/bin:</span><span class=nv>$PATH</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>fi</span>
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span><span class=line><span class=cl><span class=nb>unset</span> __conda_setup
</span></span><span class=line><span class=cl><span class=c1># &lt;&lt;&lt; conda initialize &lt;&lt;&lt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Run the JupyterHub service with the system configuration</span>
</span></span><span class=line><span class=cl>jupyterhub -f /etc/jupyterhub/jupyterhub_config.py
</span></span></code></pre></div><p>Create a systemd service by writing the following into <code>/etc/systemd/system/jupyterhub.service</code>:</p><pre tabindex=0><code>[Unit]
Description=JupyterHub
Documentation=https://jupyterhub.readthedocs.io/en/stable/

[Service]
Type=simple
After=network.target
Restart=always
RestartSec=10

WorkingDirectory=/srv/jupyterhub
ExecStart=/usr/local/bin/run_jupyterhub.sh

StandardOutput=syslog
StandardError=syslog
SyslogIdentifier=jupyterhub

[Install]
WantedBy=multi-user.target
</code></pre><p>You can now enable and start the server as follows:</p><pre tabindex=0><code>$ sudo systemctl enable jupyterhub.service
$ sudo systemctl start jupyterhub.service
</code></pre><p>You should now be able to go to the server and access JupyterHub without running it specifically as the user. To diagnose issues, use <code>journalctl</code> as follows:</p><pre tabindex=0><code>$ sudo journalctl -u jupyterhub.service
</code></pre><p>This will open up the log file and tell you if anything went wrong.</p><h3 id=step-7-handle-logging>Step 7: Handle Logging<a hidden class=anchor aria-hidden=true href=#step-7-handle-logging>#</a></h3><p>Our systemd service writes all output to the syslog. By default we can access the logs using <code>journalctl</code>. However, to make debugging easier, we can use <code>rsyslog</code> to write the logs into a file. Add the following in <code>/etc/rsyslog/jupyterhub.conf</code>:</p><pre tabindex=0><code>if $programname == &#39;jupyterhub&#39; then /var/log/jupyterhub/access.log
&amp; stop
</code></pre><p>Note also that you might have to add a priority to the configuration, e.g. <code>22-jupyterhub.conf</code> to ensure that rsyslog executes it correctly. Create the logging directory and give it the correct permissions, then restart rsyslog:</p><pre tabindex=0><code>$ mkdir /var/log/jupyterhub
$ chown root:syslog /var/log/jupyterhub
$ chmod 775 /var/log/jupyterhub
$ systemctl restart rsyslog.service
</code></pre><p>To make sure the logs don&rsquo;t get too large, add the following to <code>/etc/logrotate.d/jupyterhub.conf</code>:</p><pre tabindex=0><code>/var/log/jupyterhub/access.log
{
        daily
        rotate 15
        size 50M
        missingok
        notifempty
        compress
        delaycompress
        dateext
        dateformat -%Y-%m-%d
        create 0644 root root
}
</code></pre><p>This will ensure that the logs are compressed and rotated daily and that they will be deleted after 15 days.</p></div><footer class=post-footer><ul class=post-tags></ul><nav class=paginav><a class=prev href=https://bbengfort.github.io/2020/07/basic-python-profiling/><span class=title>« Prev</span><br><span>Basic Python Profiling</span>
</a><a class=next href=https://bbengfort.github.io/2019/02/mount-ebs-volume/><span class=title>Next »</span><br><span>Mount an EBS volume</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2024 <a href=https://bbengfort.github.io/>Libelli</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>