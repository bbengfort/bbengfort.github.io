<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Writing JSON into a Zip file with Python | Libelli</title>
<meta name=keywords content><meta name=description content="For scientific reproducibility, it has become common for me to output experimental results as zip files that contain both configurations and inputs as well as one or more output results files. This is similar to .epub or .docx formats which are just specialized zip files - and allows me to easily rerun experiments for comparison purposes. Recently I tried to dump some json data into a zip file using Python 3.8 and was surprised when the code errored as it seemed pretty standard. This is the story of the crazy loophole that I had to go into as a result."><meta name=author content="Benjamin Bengfort"><link rel=canonical href=https://bbengfort.github.io/2020/08/zipfiles-json/><link crossorigin=anonymous href=/assets/css/stylesheet.fc220c15db4aef0318bbf30adc45d33d4d7c88deff3238b23eb255afdc472ca6.css integrity="sha256-/CIMFdtK7wMYu/MK3EXTPU18iN7/MjiyPrJVr9xHLKY=" rel="preload stylesheet" as=style><link rel=icon href=https://bbengfort.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://bbengfort.github.io/icon.png><link rel=icon type=image/png sizes=32x32 href=https://bbengfort.github.io/icon.png><link rel=apple-touch-icon href=https://bbengfort.github.io/apple-touch-icon-precomposed.png><link rel=mask-icon href=https://bbengfort.github.io/icon.png><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://bbengfort.github.io/2020/08/zipfiles-json/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-D3BE7EHHVP"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-D3BE7EHHVP")}</script><meta property="og:title" content="Writing JSON into a Zip file with Python"><meta property="og:description" content="For scientific reproducibility, it has become common for me to output experimental results as zip files that contain both configurations and inputs as well as one or more output results files. This is similar to .epub or .docx formats which are just specialized zip files - and allows me to easily rerun experiments for comparison purposes. Recently I tried to dump some json data into a zip file using Python 3.8 and was surprised when the code errored as it seemed pretty standard. This is the story of the crazy loophole that I had to go into as a result."><meta property="og:type" content="article"><meta property="og:url" content="https://bbengfort.github.io/2020/08/zipfiles-json/"><meta property="og:image" content="https://bbengfort.github.io/bear.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-08-20T11:41:14+00:00"><meta property="article:modified_time" content="2020-08-20T11:41:14+00:00"><meta property="og:site_name" content="Libelli"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://bbengfort.github.io/bear.png"><meta name=twitter:title content="Writing JSON into a Zip file with Python"><meta name=twitter:description content="For scientific reproducibility, it has become common for me to output experimental results as zip files that contain both configurations and inputs as well as one or more output results files. This is similar to .epub or .docx formats which are just specialized zip files - and allows me to easily rerun experiments for comparison purposes. Recently I tried to dump some json data into a zip file using Python 3.8 and was surprised when the code errored as it seemed pretty standard. This is the story of the crazy loophole that I had to go into as a result."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://bbengfort.github.io/posts/"},{"@type":"ListItem","position":2,"name":"Writing JSON into a Zip file with Python","item":"https://bbengfort.github.io/2020/08/zipfiles-json/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Writing JSON into a Zip file with Python","name":"Writing JSON into a Zip file with Python","description":"For scientific reproducibility, it has become common for me to output experimental results as zip files that contain both configurations and inputs as well as one or more output results files. This is similar to .epub or .docx formats which are just specialized zip files - and allows me to easily rerun experiments for comparison purposes. Recently I tried to dump some json data into a zip file using Python 3.8 and was surprised when the code errored as it seemed pretty standard. This is the story of the crazy loophole that I had to go into as a result.\n","keywords":[],"articleBody":"For scientific reproducibility, it has become common for me to output experimental results as zip files that contain both configurations and inputs as well as one or more output results files. This is similar to .epub or .docx formats which are just specialized zip files - and allows me to easily rerun experiments for comparison purposes. Recently I tried to dump some json data into a zip file using Python 3.8 and was surprised when the code errored as it seemed pretty standard. This is the story of the crazy loophole that I had to go into as a result.\nFirst off, here is the code that didn’t work:\ndef make_archive_bad(path=\"test.zip\"): with zipfile.ZipFile(path, \"x\") as z: with z.open(\"config.json\", \"w\") as c: # This doesn't work json.dump(config, c, indent=2) with z.open(\"data.json\", \"w\") as d: for row in data(config): # This doesn't work d.write(json.dumps(row)) d.write(\"\\n\") The exception is located in the interaction between json.dump and zipfile._ZipWriteFile.write as you can see in the traceback below.\nFile \"./zipr.py\", line 144, in make_archive_bad() File \"./zipr.py\", line 32, in make_archive_bad json.dump(config, c, indent=2) File \"3.7/lib/python3.7/json/__init__.py\", line 180, in dump fp.write(chunk) File \"3.7/lib/python3.7/zipfile.py\", line 1094, in write self._crc = crc32(data, self._crc) TypeError: a bytes-like object is required, not 'str' The json module always produces str objects, not bytes objects. Therefore, fp.write() must support str input.\n— json documentation\nSo the issue is really with the zipfile library and to make it work, you’ll have to json.dumps and then encode your data yourself. Which is annoying:\ndef make_archive_annoying(path=\"test.zip\"): # This does work but is annoying # Also note, this will write to the root of the archive, and when unzipped will not # unzip to a directory but rather into the same directory as the zip file with zipfile.ZipFile(path, \"x\") as z: with z.open(\"config.json\", \"w\") as c: c.write(json.dumps(config, indent=2).encode(\"utf-8\")) with z.open(\"data.json\", \"w\") as d: for row in data(config): d.write(json.dumps(row).encode(\"utf-8\")) d.write(\"\\n\".encode(\"utf-8\")) For 99% of people, the above solution is the way to go. However, as soon as I realized that this was also going to write into the root of the zip file so that when you extract the contents they are in the same directory as the zip file instead of a subdirectory … I went a little overboard. So here is a solution that is not annoying but requires some wrapper utility code in your library.\nI’m sorry.\nclass Zipr(object): def __enter__(self): # Makes this thing a context manager return self def __exit__(self, exc_type, exc_value, traceback): # Makes this thing a context manager self.close() def close(self): self.zobj.close() class ZipArchive(Zipr): def __init__(self, path, mode=\"r\"): self.zobj = zipfile.ZipFile( path, mode, compression=zipfile.ZIP_STORED, allowZip64=True, compresslevel=None ) self.root, _ = os.path.splitext(os.path.basename(path)) def open(self, path, mode='r'): # Write into a directory instead of the root of the zip file path = os.path.join(self.root, path) return ZipArchiveFile(self.zobj.open(path, mode)) class ZipArchiveFile(Zipr): def __init__(self, zobj, encoding=\"utf-8\"): self.zobj = zobj self.encoding = encoding def write(self, data): if isinstance(data, str): data = data.encode(self.encoding) self.zobj.write(data) These classes are essentially just wrappers for ZipFile and _ZipWriteFile, so potentially it would just be easier to subclass these files and and override the open and write methods - but I’ll leave that to the reader to make a decision. This is enough to have less annoying code:\ndef make_archive(path=\"test.zip\"): # Less annoying make archive with workaround classes with ZipArchive(path, \"x\") as z: with z.open(\"config.json\", \"w\") as c: json.dump(config, c, indent=2) with z.open(\"data.json\", \"w\") as d: for row in data(config): d.write(json.dumps(row)) d.write(\"\\n\") There are still issues, however. For example append ('a') mode does not work with _ZipWriteFile, so if you try to stream data by opening for appending, you’ll run into issues. See below:\ndef make_archive_stream(path=\"test.zip\"): # Attempts to open the internal zip file for appending, to stream data in. # But this doesn't work because you can't open an internal zip object for appending with ZipArchive(path, \"x\") as z: with z.open(\"config.json\", \"w\") as c: json.dump(config, c, indent=2) cache = [] for i, row in enumerate(data(config)): cache.append(json.dumps(row)) # dump cache every 5 rows if i%5 == 0: with z.open(\"data.json\", \"a\") as d: for row in cache: d.write(row+\"\\n\") cache = [] if len(cache) \u003e 0: with z.open(\"data.json\", \"a\") as d: for row in cache: d.write(row+\"\\n\") The full code can be found on this gist.\n","wordCount":"700","inLanguage":"en","image":"https://bbengfort.github.io/bear.png","datePublished":"2020-08-20T11:41:14Z","dateModified":"2020-08-20T11:41:14Z","author":{"@type":"Person","name":"Benjamin Bengfort"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://bbengfort.github.io/2020/08/zipfiles-json/"},"publisher":{"@type":"Organization","name":"Libelli","logo":{"@type":"ImageObject","url":"https://bbengfort.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://bbengfort.github.io/ accesskey=h title="Libelli (Alt + H)"><img src=https://bbengfort.github.io/icon.png alt aria-label=logo height=35>Libelli</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://bbengfort.github.io/archive/ title=archive><span>archive</span></a></li><li><a href=https://bbengfort.github.io/categories/ title=categories><span>categories</span></a></li><li><a href=https://bbengfort.github.io/search/ title="search (Alt + /)" accesskey=/><span>search</span></a></li><li><a href=https://bbengfort.github.io/about/ title=about><span>about</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://bbengfort.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://bbengfort.github.io/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">Writing JSON into a Zip file with Python</h1><div class=post-meta><span title='2020-08-20 11:41:14 +0000 UTC'>August 20, 2020</span>&nbsp;·&nbsp;4 min&nbsp;·&nbsp;700 words&nbsp;·&nbsp;Benjamin Bengfort&nbsp;|&nbsp;<a href=https://github.com/bbengfort/bbengfort.github.io/tree/main/content/posts/2020-08-20-zipfiles-json.md rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><div class=post-content><p>For scientific reproducibility, it has become common for me to output experimental results as zip files that contain both configurations and inputs as well as one or more output results files. This is similar to .epub or .docx formats which are just specialized zip files - and allows me to easily rerun experiments for comparison purposes. Recently I tried to dump some json data into a zip file using Python 3.8 and was surprised when the code errored as it seemed pretty standard. This is the story of the crazy loophole that I had to go into as a result.</p><p>First off, here is the code that didn&rsquo;t work:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>make_archive_bad</span><span class=p>(</span><span class=n>path</span><span class=o>=</span><span class=s2>&#34;test.zip&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>with</span> <span class=n>zipfile</span><span class=o>.</span><span class=n>ZipFile</span><span class=p>(</span><span class=n>path</span><span class=p>,</span> <span class=s2>&#34;x&#34;</span><span class=p>)</span> <span class=k>as</span> <span class=n>z</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>with</span> <span class=n>z</span><span class=o>.</span><span class=n>open</span><span class=p>(</span><span class=s2>&#34;config.json&#34;</span><span class=p>,</span> <span class=s2>&#34;w&#34;</span><span class=p>)</span> <span class=k>as</span> <span class=n>c</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># This doesn&#39;t work</span>
</span></span><span class=line><span class=cl>            <span class=n>json</span><span class=o>.</span><span class=n>dump</span><span class=p>(</span><span class=n>config</span><span class=p>,</span> <span class=n>c</span><span class=p>,</span> <span class=n>indent</span><span class=o>=</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>with</span> <span class=n>z</span><span class=o>.</span><span class=n>open</span><span class=p>(</span><span class=s2>&#34;data.json&#34;</span><span class=p>,</span> <span class=s2>&#34;w&#34;</span><span class=p>)</span> <span class=k>as</span> <span class=n>d</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>row</span> <span class=ow>in</span> <span class=n>data</span><span class=p>(</span><span class=n>config</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=c1># This doesn&#39;t work</span>
</span></span><span class=line><span class=cl>                <span class=n>d</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=n>json</span><span class=o>.</span><span class=n>dumps</span><span class=p>(</span><span class=n>row</span><span class=p>))</span>
</span></span><span class=line><span class=cl>                <span class=n>d</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span></code></pre></div><p>The exception is located in the interaction between <code>json.dump</code> and <code>zipfile._ZipWriteFile.write</code> as you can see in the traceback below.</p><pre tabindex=0><code>  File &#34;./zipr.py&#34;, line 144, in &lt;module&gt;
    make_archive_bad()
  File &#34;./zipr.py&#34;, line 32, in make_archive_bad
    json.dump(config, c, indent=2)
  File &#34;3.7/lib/python3.7/json/__init__.py&#34;, line 180, in dump
    fp.write(chunk)
  File &#34;3.7/lib/python3.7/zipfile.py&#34;, line 1094, in write
    self._crc = crc32(data, self._crc)
TypeError: a bytes-like object is required, not &#39;str&#39;
</code></pre><blockquote><p>The json module always produces str objects, not bytes objects. Therefore, fp.write() must support str input.</p><p>— <a href=https://docs.python.org/3/library/json.html#basic-usage>json documentation</a></p></blockquote><p>So the issue is really with the zipfile library and to make it work, you&rsquo;ll have to <code>json.dumps</code> and then encode your data yourself. Which is annoying:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>make_archive_annoying</span><span class=p>(</span><span class=n>path</span><span class=o>=</span><span class=s2>&#34;test.zip&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=c1># This does work but is annoying</span>
</span></span><span class=line><span class=cl>    <span class=c1># Also note, this will write to the root of the archive, and when unzipped will not</span>
</span></span><span class=line><span class=cl>    <span class=c1># unzip to a directory but rather into the same directory as the zip file</span>
</span></span><span class=line><span class=cl>    <span class=k>with</span> <span class=n>zipfile</span><span class=o>.</span><span class=n>ZipFile</span><span class=p>(</span><span class=n>path</span><span class=p>,</span> <span class=s2>&#34;x&#34;</span><span class=p>)</span> <span class=k>as</span> <span class=n>z</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>with</span> <span class=n>z</span><span class=o>.</span><span class=n>open</span><span class=p>(</span><span class=s2>&#34;config.json&#34;</span><span class=p>,</span> <span class=s2>&#34;w&#34;</span><span class=p>)</span> <span class=k>as</span> <span class=n>c</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>c</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=n>json</span><span class=o>.</span><span class=n>dumps</span><span class=p>(</span><span class=n>config</span><span class=p>,</span> <span class=n>indent</span><span class=o>=</span><span class=mi>2</span><span class=p>)</span><span class=o>.</span><span class=n>encode</span><span class=p>(</span><span class=s2>&#34;utf-8&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>with</span> <span class=n>z</span><span class=o>.</span><span class=n>open</span><span class=p>(</span><span class=s2>&#34;data.json&#34;</span><span class=p>,</span> <span class=s2>&#34;w&#34;</span><span class=p>)</span> <span class=k>as</span> <span class=n>d</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>row</span> <span class=ow>in</span> <span class=n>data</span><span class=p>(</span><span class=n>config</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=n>d</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=n>json</span><span class=o>.</span><span class=n>dumps</span><span class=p>(</span><span class=n>row</span><span class=p>)</span><span class=o>.</span><span class=n>encode</span><span class=p>(</span><span class=s2>&#34;utf-8&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>                <span class=n>d</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>&#34;</span><span class=o>.</span><span class=n>encode</span><span class=p>(</span><span class=s2>&#34;utf-8&#34;</span><span class=p>))</span>
</span></span></code></pre></div><p>For 99% of people, the above solution is the way to go. However, as soon as I realized that this was also going to write into the root of the zip file so that when you extract the contents they are in the same directory as the zip file instead of a subdirectory &mldr; I went a little overboard. So here is a solution that is not annoying but requires some wrapper utility code in your library.</p><p>I&rsquo;m sorry.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>class</span> <span class=nc>Zipr</span><span class=p>(</span><span class=nb>object</span><span class=p>):</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__enter__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=c1># Makes this thing a context manager</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=bp>self</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__exit__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>exc_type</span><span class=p>,</span> <span class=n>exc_value</span><span class=p>,</span> <span class=n>traceback</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=c1># Makes this thing a context manager</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>close</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>zobj</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>ZipArchive</span><span class=p>(</span><span class=n>Zipr</span><span class=p>):</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>path</span><span class=p>,</span> <span class=n>mode</span><span class=o>=</span><span class=s2>&#34;r&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>zobj</span> <span class=o>=</span> <span class=n>zipfile</span><span class=o>.</span><span class=n>ZipFile</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>path</span><span class=p>,</span> <span class=n>mode</span><span class=p>,</span> <span class=n>compression</span><span class=o>=</span><span class=n>zipfile</span><span class=o>.</span><span class=n>ZIP_STORED</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>allowZip64</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>compresslevel</span><span class=o>=</span><span class=kc>None</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>root</span><span class=p>,</span> <span class=n>_</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>splitext</span><span class=p>(</span><span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>basename</span><span class=p>(</span><span class=n>path</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>open</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>path</span><span class=p>,</span> <span class=n>mode</span><span class=o>=</span><span class=s1>&#39;r&#39;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=c1># Write into a directory instead of the root of the zip file</span>
</span></span><span class=line><span class=cl>        <span class=n>path</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>root</span><span class=p>,</span> <span class=n>path</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>ZipArchiveFile</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>zobj</span><span class=o>.</span><span class=n>open</span><span class=p>(</span><span class=n>path</span><span class=p>,</span> <span class=n>mode</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>ZipArchiveFile</span><span class=p>(</span><span class=n>Zipr</span><span class=p>):</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>zobj</span><span class=p>,</span> <span class=n>encoding</span><span class=o>=</span><span class=s2>&#34;utf-8&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>zobj</span> <span class=o>=</span> <span class=n>zobj</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>encoding</span> <span class=o>=</span> <span class=n>encoding</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>write</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>data</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>data</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>data</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>encode</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>encoding</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>zobj</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=n>data</span><span class=p>)</span>
</span></span></code></pre></div><p>These classes are essentially just wrappers for <code>ZipFile</code> and <code>_ZipWriteFile</code>, so potentially it would just be easier to subclass these files and and override the <code>open</code> and <code>write</code> methods - but I&rsquo;ll leave that to the reader to make a decision. This is enough to have less annoying code:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>make_archive</span><span class=p>(</span><span class=n>path</span><span class=o>=</span><span class=s2>&#34;test.zip&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=c1># Less annoying make archive with workaround classes</span>
</span></span><span class=line><span class=cl>    <span class=k>with</span> <span class=n>ZipArchive</span><span class=p>(</span><span class=n>path</span><span class=p>,</span> <span class=s2>&#34;x&#34;</span><span class=p>)</span> <span class=k>as</span> <span class=n>z</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>with</span> <span class=n>z</span><span class=o>.</span><span class=n>open</span><span class=p>(</span><span class=s2>&#34;config.json&#34;</span><span class=p>,</span> <span class=s2>&#34;w&#34;</span><span class=p>)</span> <span class=k>as</span> <span class=n>c</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>json</span><span class=o>.</span><span class=n>dump</span><span class=p>(</span><span class=n>config</span><span class=p>,</span> <span class=n>c</span><span class=p>,</span> <span class=n>indent</span><span class=o>=</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>with</span> <span class=n>z</span><span class=o>.</span><span class=n>open</span><span class=p>(</span><span class=s2>&#34;data.json&#34;</span><span class=p>,</span> <span class=s2>&#34;w&#34;</span><span class=p>)</span> <span class=k>as</span> <span class=n>d</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>row</span> <span class=ow>in</span> <span class=n>data</span><span class=p>(</span><span class=n>config</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=n>d</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=n>json</span><span class=o>.</span><span class=n>dumps</span><span class=p>(</span><span class=n>row</span><span class=p>))</span>
</span></span><span class=line><span class=cl>                <span class=n>d</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span></code></pre></div><p>There are still issues, however. For example append (<code>'a'</code>) mode does not work with <code>_ZipWriteFile</code>, so if you try to stream data by opening for appending, you&rsquo;ll run into issues. See below:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>make_archive_stream</span><span class=p>(</span><span class=n>path</span><span class=o>=</span><span class=s2>&#34;test.zip&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=c1># Attempts to open the internal zip file for appending, to stream data in.</span>
</span></span><span class=line><span class=cl>    <span class=c1># But this doesn&#39;t work because you can&#39;t open an internal zip object for appending</span>
</span></span><span class=line><span class=cl>    <span class=k>with</span> <span class=n>ZipArchive</span><span class=p>(</span><span class=n>path</span><span class=p>,</span> <span class=s2>&#34;x&#34;</span><span class=p>)</span> <span class=k>as</span> <span class=n>z</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>with</span> <span class=n>z</span><span class=o>.</span><span class=n>open</span><span class=p>(</span><span class=s2>&#34;config.json&#34;</span><span class=p>,</span> <span class=s2>&#34;w&#34;</span><span class=p>)</span> <span class=k>as</span> <span class=n>c</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>json</span><span class=o>.</span><span class=n>dump</span><span class=p>(</span><span class=n>config</span><span class=p>,</span> <span class=n>c</span><span class=p>,</span> <span class=n>indent</span><span class=o>=</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>cache</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>row</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>data</span><span class=p>(</span><span class=n>config</span><span class=p>)):</span>
</span></span><span class=line><span class=cl>            <span class=n>cache</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>json</span><span class=o>.</span><span class=n>dumps</span><span class=p>(</span><span class=n>row</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1># dump cache every 5 rows</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>i</span><span class=o>%</span><span class=mi>5</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>with</span> <span class=n>z</span><span class=o>.</span><span class=n>open</span><span class=p>(</span><span class=s2>&#34;data.json&#34;</span><span class=p>,</span> <span class=s2>&#34;a&#34;</span><span class=p>)</span> <span class=k>as</span> <span class=n>d</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=k>for</span> <span class=n>row</span> <span class=ow>in</span> <span class=n>cache</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                        <span class=n>d</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=n>row</span><span class=o>+</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=n>cache</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>cache</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>with</span> <span class=n>z</span><span class=o>.</span><span class=n>open</span><span class=p>(</span><span class=s2>&#34;data.json&#34;</span><span class=p>,</span> <span class=s2>&#34;a&#34;</span><span class=p>)</span> <span class=k>as</span> <span class=n>d</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>for</span> <span class=n>row</span> <span class=ow>in</span> <span class=n>cache</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>d</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=n>row</span><span class=o>+</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span></code></pre></div><p>The full code can be found on <a href=https://gist.github.com/bbengfort/73c142188085e6b417b49d3897fa7d24>this gist</a>.</p></div><footer class=post-footer><ul class=post-tags></ul><nav class=paginav><a class=prev href=https://bbengfort.github.io/2020/10/go-multiple-errors/><span class=title>« Prev</span><br><span>Managing Multi-Errors in Go</span>
</a><a class=next href=https://bbengfort.github.io/2020/07/read-mprofile-into-pandas/><span class=title>Next »</span><br><span>Read mprofile Output into Pandas</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2024 <a href=https://bbengfort.github.io/>Libelli</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>